<!DOCTYPE html><html lang="zh-Hans"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/next-blog/_next/static/css/8543050952beacbd.css" as="style"/><link rel="stylesheet" href="/next-blog/_next/static/css/8543050952beacbd.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/next-blog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/next-blog/_next/static/chunks/webpack-3cfba94e1de595e3.js" defer=""></script><script src="/next-blog/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/next-blog/_next/static/chunks/main-1c9e93b8392c1bc9.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/_app-bc0777daea9f4a0d.js" defer=""></script><script src="/next-blog/_next/static/chunks/963-7455877b8d482f59.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/blog/%5Bslug%5D-2094ee9b50c39180.js" defer=""></script><script src="/next-blog/_next/static/ZAv09URXGddjeP1v_KZGc/_buildManifest.js" defer=""></script><script src="/next-blog/_next/static/ZAv09URXGddjeP1v_KZGc/_ssgManifest.js" defer=""></script><script src="/next-blog/_next/static/ZAv09URXGddjeP1v_KZGc/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><section class="p-12"><div><a href="/next-blog">Home</a><article class="article heti"><h1>React æ¶æ„</h1><p><time class="heti-meta heti-small">2021-12-23 22:35:09</time></p><section><h2 id="react-çš„æ¶æ„å¤§æ¦‚åˆ†ä¸º">React çš„æ¶æ„å¤§æ¦‚åˆ†ä¸º</h2>
<ul>
<li>Schedulerï¼ˆè°ƒåº¦å™¨ï¼‰â€”â€” è°ƒåº¦ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜ä»»åŠ¡ä¼˜å…ˆè¿›å…¥ Reconciler</li>
<li>Reconcilerï¼ˆåè°ƒå™¨ï¼‰â€”â€” è´Ÿè´£æ‰¾å‡ºå˜åŒ–çš„ç»„ä»¶</li>
<li>Rendererï¼ˆæ¸²æŸ“å™¨ï¼‰â€”â€” è´Ÿè´£å°†å˜åŒ–çš„ç»„ä»¶æ¸²æŸ“åˆ°é¡µé¢ä¸Š</li>
</ul>
<p>Reconciler å·¥ä½œçš„é˜¶æ®µè¢«ç§°ä¸º render é˜¶æ®µã€‚å› ä¸ºåœ¨è¯¥é˜¶æ®µä¼šè°ƒç”¨ç»„ä»¶çš„ render æ–¹æ³•ã€‚
Renderer å·¥ä½œçš„é˜¶æ®µè¢«ç§°ä¸º commit é˜¶æ®µã€‚å°±åƒä½ å®Œæˆä¸€ä¸ªéœ€æ±‚çš„ç¼–ç åæ‰§è¡Œ git commit æäº¤ä»£ç ã€‚commit é˜¶æ®µä¼šæŠŠ render é˜¶æ®µæäº¤çš„ä¿¡æ¯æ¸²æŸ“åœ¨é¡µé¢ä¸Šã€‚
render ä¸ commit é˜¶æ®µç»Ÿç§°ä¸º workï¼Œå³ React åœ¨å·¥ä½œä¸­ã€‚ç›¸å¯¹åº”çš„ï¼Œå¦‚æœä»»åŠ¡æ­£åœ¨ Scheduler å†…è°ƒåº¦ï¼Œå°±ä¸å±äº workã€‚</p>
<h2 id="render-é˜¶æ®µ">Render é˜¶æ®µ</h2>
<p>Render é˜¶æ®µå¼€å§‹äº performSyncWorkOnRoot æˆ– performConcurrentWorkOnRoot æ–¹æ³•çš„è°ƒç”¨ã€‚è¿™å–å†³äºæœ¬æ¬¡æ›´æ–°æ˜¯åŒæ­¥æ›´æ–°è¿˜æ˜¯å¼‚æ­¥æ›´æ–°ã€‚</p>
<pre><code class="language-js">// performSyncWorkOnRootä¼šè°ƒç”¨è¯¥æ–¹æ³•
function workLoopSync() {
  while (workInProgress !== null) {
    performUnitOfWork(workInProgress)
  }
}

// performConcurrentWorkOnRootä¼šè°ƒç”¨è¯¥æ–¹æ³•
function workLoopConcurrent() {
  while (workInProgress !== null &amp;&amp; !shouldYield()) {
    performUnitOfWork(workInProgress)
  }
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä»–ä»¬å”¯ä¸€çš„åŒºåˆ«æ˜¯æ˜¯å¦è°ƒç”¨ shouldYieldã€‚å¦‚æœå½“å‰æµè§ˆå™¨å¸§æ²¡æœ‰å‰©ä½™æ—¶é—´ï¼ŒshouldYield ä¼šä¸­æ­¢å¾ªç¯ï¼Œç›´åˆ°æµè§ˆå™¨æœ‰ç©ºé—²æ—¶é—´åå†ç»§ç»­éå†ã€‚</p>
<p>workInProgress ä»£è¡¨å½“å‰å·²åˆ›å»ºçš„ workInProgress fiberã€‚</p>
<p>performUnitOfWork æ–¹æ³•ä¼šåˆ›å»ºä¸‹ä¸€ä¸ª Fiber èŠ‚ç‚¹å¹¶èµ‹å€¼ç»™ workInProgressï¼Œå¹¶å°† workInProgress ä¸å·²åˆ›å»ºçš„ Fiber èŠ‚ç‚¹è¿æ¥èµ·æ¥æ„æˆ Fiber æ ‘ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ Fiber Reconciler æ˜¯ä» Stack Reconciler é‡æ„è€Œæ¥ï¼Œé€šè¿‡éå†çš„æ–¹å¼å®ç°å¯ä¸­æ–­çš„é€’å½’ï¼Œæ‰€ä»¥ performUnitOfWork çš„å·¥ä½œå¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šâ€œé€’â€å’Œâ€œå½’â€</p>
<h3 id="é€’é˜¶æ®µ">â€œé€’â€é˜¶æ®µ</h3>
<p>é¦–å…ˆä» rootFiber å¼€å§‹å‘ä¸‹æ·±åº¦ä¼˜å…ˆéå†ã€‚ä¸ºéå†åˆ°çš„æ¯ä¸ª Fiber èŠ‚ç‚¹è°ƒç”¨ beginWork æ–¹æ³•ã€‚
è¯¥æ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥çš„ Fiber èŠ‚ç‚¹åˆ›å»ºå­ Fiber èŠ‚ç‚¹ï¼Œå¹¶å°†è¿™ä¸¤ä¸ª Fiber èŠ‚ç‚¹è¿æ¥èµ·æ¥ã€‚
å½“éå†åˆ°å¶å­èŠ‚ç‚¹ï¼ˆå³æ²¡æœ‰å­ç»„ä»¶çš„ç»„ä»¶ï¼‰æ—¶å°±ä¼šè¿›å…¥â€œå½’â€é˜¶æ®µã€‚</p>
<h3 id="å½’é˜¶æ®µ">â€œå½’â€é˜¶æ®µ</h3>
<p>åœ¨â€œå½’â€é˜¶æ®µä¼šè°ƒç”¨ completeWork å¤„ç† Fiber èŠ‚ç‚¹ã€‚
å½“æŸä¸ª Fiber èŠ‚ç‚¹æ‰§è¡Œå®Œ completeWorkï¼Œ
å¦‚æœå…¶å­˜åœ¨å…„å¼Ÿ Fiber èŠ‚ç‚¹ï¼ˆå³ fiber.sibling !== nullï¼‰ï¼Œä¼šè¿›å…¥å…¶å…„å¼Ÿ Fiber çš„â€œé€’â€é˜¶æ®µã€‚
å¦‚æœä¸å­˜åœ¨å…„å¼Ÿ Fiberï¼Œä¼šè¿›å…¥çˆ¶çº§ Fiber çš„â€œå½’â€é˜¶æ®µã€‚</p>
<p>â€œé€’â€å’Œâ€œå½’â€é˜¶æ®µä¼šäº¤é”™æ‰§è¡Œç›´åˆ°â€œå½’â€åˆ° rootFiberã€‚è‡³æ­¤ï¼Œrender é˜¶æ®µçš„å·¥ä½œå°±ç»“æŸäº†ã€‚</p>
<p>render é˜¶æ®µå…¨éƒ¨å·¥ä½œå®Œæˆã€‚åœ¨ performSyncWorkOnRoot å‡½æ•°ä¸­ fiberRootNode è¢«ä¼ é€’ç»™ commitRoot æ–¹æ³•ï¼Œå¼€å¯ commit é˜¶æ®µå·¥ä½œæµç¨‹ã€‚</p>
<h2 id="commit-é˜¶æ®µ">Commit é˜¶æ®µ</h2>
<p>commitRoot æ–¹æ³•æ˜¯ commit é˜¶æ®µå·¥ä½œçš„èµ·ç‚¹ã€‚fiberRootNode ä¼šä½œä¸ºä¼ å‚ã€‚</p>
<pre><code class="language-js">commitRoot(root)
</code></pre>
<p>åœ¨ rootFiber.firstEffect ä¸Šä¿å­˜äº†ä¸€æ¡éœ€è¦æ‰§è¡Œå‰¯ä½œç”¨çš„ Fiber èŠ‚ç‚¹çš„å•å‘é“¾è¡¨ effectListï¼Œè¿™äº› Fiber èŠ‚ç‚¹çš„ updateQueue ä¸­ä¿å­˜äº†å˜åŒ–çš„ propsã€‚</p>
<p>è¿™äº›å‰¯ä½œç”¨å¯¹åº”çš„ DOM æ“ä½œåœ¨ commit é˜¶æ®µæ‰§è¡Œã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œä¸€äº›ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆæ¯”å¦‚ componentDidXXXï¼‰ã€hookï¼ˆæ¯”å¦‚ useEffectï¼‰éœ€è¦åœ¨ commit é˜¶æ®µæ‰§è¡Œã€‚</p>
<p>commit é˜¶æ®µçš„ä¸»è¦å·¥ä½œï¼ˆå³ Renderer çš„å·¥ä½œæµç¨‹ï¼‰åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p>
<ul>
<li>before mutation é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œå‰ï¼‰</li>
<li>mutation é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œï¼‰</li>
<li>layout é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œåï¼‰</li>
</ul>
<p>åœ¨ before mutation é˜¶æ®µä¹‹å‰å’Œ layout é˜¶æ®µä¹‹åè¿˜æœ‰ä¸€äº›é¢å¤–å·¥ä½œï¼Œæ¶‰åŠåˆ°æ¯”å¦‚ useEffect çš„è§¦å‘ã€ä¼˜å…ˆçº§ç›¸å…³çš„é‡ç½®ã€ref çš„ç»‘å®š/è§£ç»‘ã€‚</p>
<h3 id="before-mutation-ä¹‹å‰">before mutation ä¹‹å‰</h3>
<p>commitRootImpl æ–¹æ³•ä¸­ç›´åˆ°ç¬¬ä¸€å¥ <code>if (firstEffect !== null)</code> ä¹‹å‰å±äº before mutation ä¹‹å‰ã€‚</p>
<p>before mutation ä¹‹å‰ä¸»è¦åšä¸€äº›å˜é‡èµ‹å€¼ï¼ŒçŠ¶æ€é‡ç½®çš„å·¥ä½œã€‚</p>
<h3 id="layout-ä¹‹å">layout ä¹‹å</h3>
<p>ä¸»è¦åŒ…æ‹¬ä¸‰ç‚¹å†…å®¹ï¼š</p>
<ul>
<li>useEffect ç›¸å…³çš„å¤„ç†ã€‚</li>
<li>æ€§èƒ½è¿½è¸ªç›¸å…³ã€‚
æºç é‡Œæœ‰å¾ˆå¤šå’Œ interaction ç›¸å…³çš„å˜é‡ã€‚ä»–ä»¬éƒ½å’Œè¿½è¸ª React æ¸²æŸ“æ—¶é—´ã€æ€§èƒ½ç›¸å…³ï¼Œåœ¨ Profiler API å’Œ DevTools ä¸­ä½¿ç”¨ã€‚</li>
<li>åœ¨ commit é˜¶æ®µä¼šè§¦å‘ä¸€äº›ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå¦‚ componentDidXXXï¼‰å’Œ hookï¼ˆå¦‚ useLayoutEffectã€useEffectï¼‰ã€‚</li>
</ul>
<p>åœ¨è¿™äº›å›è°ƒæ–¹æ³•ä¸­å¯èƒ½è§¦å‘æ–°çš„æ›´æ–°ï¼Œæ–°çš„æ›´æ–°ä¼šå¼€å¯æ–°çš„ render-commit æµç¨‹ã€‚</p>
<h3 id="before-mutation">before mutation</h3>
<p>before mutation é˜¶æ®µçš„ä»£ç å¾ˆçŸ­ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯éå† effectList å¹¶è°ƒç”¨ commitBeforeMutationEffects å‡½æ•°å¤„ç†ã€‚</p>
<h4 id="commitbeforemutationeffects">commitBeforeMutationEffects</h4>
<p>æ•´ä½“å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p>
<ol>
<li>å¤„ç† DOM èŠ‚ç‚¹æ¸²æŸ“/åˆ é™¤åçš„ autoFocusã€blur é€»è¾‘ã€‚</li>
<li>è°ƒç”¨ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚</li>
<li>è°ƒåº¦ useEffectã€‚</li>
</ol>
<h5 id="è°ƒç”¨-getsnapshotbeforeupdate">è°ƒç”¨ getSnapshotBeforeUpdate</h5>
<p>ä» Reactv16 å¼€å§‹ï¼ŒcomponentWillXXX é’©å­å‰å¢åŠ äº† UNSAFE_ å‰ç¼€ã€‚</p>
<p>ç©¶å…¶åŸå› ï¼Œæ˜¯å› ä¸º Stack Reconciler é‡æ„ä¸º Fiber Reconciler åï¼Œrender é˜¶æ®µçš„ä»»åŠ¡å¯èƒ½ä¸­æ–­/é‡æ–°å¼€å§‹ï¼Œå¯¹åº”çš„ç»„ä»¶åœ¨ render é˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå³ componentWillXXX ï¼‰å¯èƒ½è§¦å‘å¤šæ¬¡ã€‚</p>
<p>ä¸ºæ­¤ï¼ŒReact æä¾›äº†æ›¿ä»£çš„ç”Ÿå‘½å‘¨æœŸé’©å­ getSnapshotBeforeUpdateï¼Œå¯ç”¨äºæ›¿æ¢ç°æœ‰çš„ componentWillUnMountã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹è§ï¼ŒgetSnapshotBeforeUpdate æ˜¯åœ¨ commit é˜¶æ®µå†…çš„ before mutation é˜¶æ®µè°ƒç”¨çš„ï¼Œç”±äº commit é˜¶æ®µæ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥ä¸ä¼šé‡åˆ°å¤šæ¬¡è°ƒç”¨çš„é—®é¢˜ã€‚</p>
<h5 id="è°ƒåº¦-useeffect">è°ƒåº¦ useEffect</h5>
<p>scheduler çš„ scheduleCallbackï¼Œç”¨äºä»¥æŸä¸ªä¼˜å…ˆçº§å¼‚æ­¥è°ƒåº¦ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚</p>
<pre><code class="language-js">// è°ƒåº¦useEffect
if ((effectTag &amp; Passive) !== NoEffect) {
  if (!rootDoesHavePassiveEffects) {
    rootDoesHavePassiveEffects = true
    scheduleCallback(NormalSchedulerPriority, () =&gt; {
      // è§¦å‘useEffect
      flushPassiveEffects()
      return null
    })
  }
}
</code></pre>
<p>è¢«å¼‚æ­¥è°ƒåº¦çš„å›è°ƒå‡½æ•°å°±æ˜¯è§¦å‘ useEffect çš„æ–¹æ³• flushPassiveEffectsã€‚ä¸‹é¢çœ‹çœ‹ä¸º useEffect å¦‚ä½•ä»¥åŠä¸ºä½•è¢«å¼‚æ­¥è°ƒåº¦ã€‚</p>
<h5 id="å¦‚ä½•å¼‚æ­¥è°ƒåº¦-useeffect">å¦‚ä½•å¼‚æ­¥è°ƒåº¦ useEffect</h5>
<p>flushPassiveEffects æ–¹æ³•å†…éƒ¨ä¼šä»å…¨å±€å˜é‡ rootWithPendingPassiveEffects è·å– effectListã€‚</p>
<p>effectList ä¸­ä¿å­˜äº†éœ€è¦æ‰§è¡Œå‰¯ä½œç”¨çš„ Fiber èŠ‚ç‚¹ã€‚å…¶ä¸­å‰¯ä½œç”¨åŒ…æ‹¬</p>
<ul>
<li>æ’å…¥ DOM èŠ‚ç‚¹ï¼ˆPlacementï¼‰</li>
<li>æ›´æ–° DOM èŠ‚ç‚¹ï¼ˆUpdateï¼‰</li>
<li>åˆ é™¤ DOM èŠ‚ç‚¹ï¼ˆDeletionï¼‰</li>
</ul>
<p>å…³äº flushPassiveEffects çš„å…·ä½“è®²è§£å‚ç…§ useEffect ä¸ useLayoutEffect ä¸€èŠ‚</p>
<p>effectList ä¸­ä¿å­˜äº†éœ€è¦æ‰§è¡Œå‰¯ä½œç”¨çš„ Fiber èŠ‚ç‚¹ã€‚å…¶ä¸­å‰¯ä½œç”¨åŒ…æ‹¬</p>
<ul>
<li>æ’å…¥ DOM èŠ‚ç‚¹ï¼ˆPlacementï¼‰</li>
<li>æ›´æ–° DOM èŠ‚ç‚¹ï¼ˆUpdateï¼‰</li>
<li>åˆ é™¤ DOM èŠ‚ç‚¹ï¼ˆDeletionï¼‰</li>
</ul>
<p>å½“ä¸€ä¸ª FunctionComponent å«æœ‰ useEffect æˆ– useLayoutEffectï¼Œä»–å¯¹åº”çš„ Fiber èŠ‚ç‚¹ä¹Ÿä¼šè¢«èµ‹å€¼ effectTagã€‚</p>
<p>æ•´ä¸ª useEffect å¼‚æ­¥è°ƒç”¨åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<ul>
<li>before mutation é˜¶æ®µåœ¨ scheduleCallback ä¸­è°ƒåº¦ flushPassiveEffects</li>
<li>layout é˜¶æ®µä¹‹åå°† effectList èµ‹å€¼ç»™ rootWithPendingPassiveEffects</li>
<li>scheduleCallback è§¦å‘ flushPassiveEffectsï¼ŒflushPassiveEffects å†…éƒ¨éå† rootWithPendingPassiveEffects</li>
</ul>
<p>ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥è°ƒç”¨
æ‘˜å½•è‡ª React æ–‡æ¡£ effect çš„æ‰§è¡Œæ—¶æœºï¼š</p>
<p>ä¸ componentDidMountã€componentDidUpdate ä¸åŒçš„æ˜¯ï¼Œåœ¨æµè§ˆå™¨å®Œæˆå¸ƒå±€ä¸ç»˜åˆ¶ä¹‹åï¼Œä¼ ç»™ useEffect çš„å‡½æ•°ä¼šå»¶è¿Ÿè°ƒç”¨ã€‚è¿™ä½¿å¾—å®ƒé€‚ç”¨äºè®¸å¤šå¸¸è§çš„å‰¯ä½œç”¨åœºæ™¯ï¼Œæ¯”å¦‚è®¾ç½®è®¢é˜…å’Œäº‹ä»¶å¤„ç†ç­‰æƒ…å†µï¼Œå› æ­¤ä¸åº”åœ¨å‡½æ•°ä¸­æ‰§è¡Œé˜»å¡æµè§ˆå™¨æ›´æ–°å±å¹•çš„æ“ä½œã€‚</p>
<p>å¯è§ï¼ŒuseEffect å¼‚æ­¥æ‰§è¡Œçš„åŸå› ä¸»è¦æ˜¯<strong>é˜²æ­¢åŒæ­¥æ‰§è¡Œæ—¶é˜»å¡æµè§ˆå™¨æ¸²æŸ“</strong>ã€‚</p>
<h3 id="mutation-é˜¶æ®µ">mutation é˜¶æ®µ</h3>
<p>mutation é˜¶æ®µä¹Ÿæ˜¯éå† effectListï¼Œæ‰§è¡Œå‡½æ•°ã€‚è¿™é‡Œæ‰§è¡Œçš„æ˜¯ commitMutationEffectsã€‚</p>
<pre><code class="language-js">nextEffect = firstEffect
do {
  try {
    commitMutationEffects(root, renderPriorityLevel)
  } catch (error) {
    invariant(nextEffect !== null, &#39;Should be working on an effect.&#39;)
    captureCommitPhaseError(nextEffect, error)
    nextEffect = nextEffect.nextEffect
  }
} while (nextEffect !== null)
</code></pre>
<h4 id="commitmutationeffects">commitMutationEffects</h4>
<pre><code class="language-js">function commitMutationEffects(root: FiberRoot, renderPriorityLevel) {
  // éå†effectList
  while (nextEffect !== null) {
    const effectTag = nextEffect.effectTag

    // æ ¹æ® ContentReset effectTagé‡ç½®æ–‡å­—èŠ‚ç‚¹
    if (effectTag &amp; ContentReset) {
      commitResetTextContent(nextEffect)
    }

    // æ›´æ–°ref
    if (effectTag &amp; Ref) {
      const current = nextEffect.alternate
      if (current !== null) {
        commitDetachRef(current)
      }
    }

    // æ ¹æ® effectTag åˆ†åˆ«å¤„ç†
    const primaryEffectTag =
      effectTag &amp; (Placement | Update | Deletion | Hydrating)
    switch (primaryEffectTag) {
      // æ’å…¥DOM
      case Placement: {
        commitPlacement(nextEffect)
        // ~ å–å
        nextEffect.effectTag &amp;= ~Placement
        break
      }
      // æ’å…¥DOM å¹¶ æ›´æ–°DOM
      case PlacementAndUpdate: {
        // æ’å…¥
        commitPlacement(nextEffect)

        nextEffect.effectTag &amp;= ~Placement

        // æ›´æ–°
        // current        æ˜¯ç°åœ¨çš„ fiber
        // workInProgress æ˜¯æ–°çš„ fiber
        // alternate      å®ƒä»¬é€šè¿‡ alternate è¿æ¥
        const current = nextEffect.alternate
        commitWork(current, nextEffect)
        break
      }
      // SSR
      case Hydrating: {
        nextEffect.effectTag &amp;= ~Hydrating
        break
      }
      // SSR
      case HydratingAndUpdate: {
        nextEffect.effectTag &amp;= ~Hydrating

        const current = nextEffect.alternate
        commitWork(current, nextEffect)
        break
      }
      // æ›´æ–°DOM
      case Update: {
        const current = nextEffect.alternate
        commitWork(current, nextEffect)
        break
      }
      // åˆ é™¤DOM
      case Deletion: {
        commitDeletion(root, nextEffect, renderPriorityLevel)
        break
      }
    }

    nextEffect = nextEffect.nextEffect
  }
}
</code></pre>
<p>commitMutationEffects ä¼šéå† effectListï¼Œå¯¹æ¯ä¸ª Fiber èŠ‚ç‚¹æ‰§è¡Œå¦‚ä¸‹ä¸‰ä¸ªæ“ä½œï¼š</p>
<ul>
<li>æ ¹æ® ContentReset effectTag é‡ç½®æ–‡å­—èŠ‚ç‚¹</li>
<li>æ›´æ–° ref</li>
<li>æ ¹æ® effectTag åˆ†åˆ«å¤„ç†ï¼Œå…¶ä¸­ effectTag åŒ…æ‹¬(Placement | Update | Deletion | Hydrating)</li>
</ul>
<h5 id="placement-effect">Placement effect</h5>
<p>å½“ Fiber èŠ‚ç‚¹å«æœ‰ Placement effectTagï¼Œæ„å‘³ç€è¯¥ Fiber èŠ‚ç‚¹å¯¹åº”çš„ DOM èŠ‚ç‚¹éœ€è¦æ’å…¥åˆ°é¡µé¢ä¸­ã€‚<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1156">code</a></p>
<ol>
<li><p>è·å–çˆ¶çº§ DOM èŠ‚ç‚¹ã€‚å…¶ä¸­ finishedWork ä¸ºä¼ å…¥çš„ Fiber èŠ‚ç‚¹ã€‚</p>
<pre><code class="language-js">const parentFiber = getHostParentFiber(finishedWork)
// çˆ¶çº§DOMèŠ‚ç‚¹
const parentStateNode = parentFiber.stateNode
</code></pre>
</li>
<li><p>è·å– Fiber èŠ‚ç‚¹çš„ DOM å…„å¼ŸèŠ‚ç‚¹</p>
<pre><code class="language-js">const before = getHostSibling(finishedWork)
</code></pre>
</li>
<li><p>æ ¹æ® DOM å…„å¼ŸèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨å†³å®šè°ƒç”¨ parentNode.insertBefore æˆ– parentNode.appendChild æ‰§è¡Œ DOM æ’å…¥æ“ä½œã€‚</p>
<pre><code class="language-js">// parentStateNodeæ˜¯å¦æ˜¯rootFiber
if (isContainer) {
  insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent)
} else {
  insertOrAppendPlacementNode(finishedWork, before, parent)
}
</code></pre>
</li>
</ol>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒgetHostSiblingï¼ˆè·å–å…„å¼Ÿ DOM èŠ‚ç‚¹ï¼‰çš„æ‰§è¡Œå¾ˆè€—æ—¶ï¼Œå½“åœ¨åŒä¸€ä¸ªçˆ¶ Fiber èŠ‚ç‚¹ä¸‹ä¾æ¬¡æ‰§è¡Œå¤šä¸ªæ’å…¥æ“ä½œï¼ŒgetHostSibling ç®—æ³•çš„å¤æ‚åº¦ä¸ºæŒ‡æ•°çº§ã€‚</p>
<p>è¿™æ˜¯ç”±äº Fiber èŠ‚ç‚¹ä¸åªåŒ…æ‹¬ HostComponentï¼Œæ‰€ä»¥ Fiber æ ‘å’Œæ¸²æŸ“çš„ DOM æ ‘èŠ‚ç‚¹å¹¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚è¦ä» Fiber èŠ‚ç‚¹æ‰¾åˆ° DOM èŠ‚ç‚¹å¾ˆå¯èƒ½è·¨å±‚çº§éå†ã€‚</p>
<p>è€ƒè™‘å¦‚ä¸‹ä¾‹å­ï¼š</p>
<pre><code class="language-js">function Item() {
  return &lt;li&gt;&lt;li&gt;;
}

function App() {
  return (
    &lt;div&gt;
      &lt;Item/&gt;
    &lt;/div&gt;
  )
}

ReactDOM.render(&lt;App/&gt;, document.getElementById(&#39;root&#39;));
</code></pre>
<p>å¯¹åº”çš„ Fiber æ ‘å’Œ DOM æ ‘ç»“æ„ä¸ºï¼š</p>
<pre><code class="language-js">// Fiberæ ‘
          child      child      child       child
rootFiber -----&gt; App -----&gt; div -----&gt; Item -----&gt; li

// DOMæ ‘
#root ---&gt; div ---&gt; li
</code></pre>
<p>å½“åœ¨ div çš„å­èŠ‚ç‚¹ Item å‰æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹ pï¼Œå³ App å˜ä¸ºï¼š</p>
<pre><code class="language-js">function App() {
  return (
    &lt;div&gt;
      &lt;p&gt;&lt;/p&gt;
      &lt;Item /&gt;
    &lt;/div&gt;
  )
}
</code></pre>
<p>å¯¹åº”çš„ Fiber æ ‘å’Œ DOM æ ‘ç»“æ„ä¸ºï¼š</p>
<pre><code class="language-js">// Fiberæ ‘
          child      child      child
rootFiber -----&gt; App -----&gt; div -----&gt; p
                                       | sibling       child
                                       | -------&gt; Item -----&gt; li
// DOMæ ‘
#root ---&gt; div ---&gt; p
             |
               ---&gt; li
</code></pre>
<p>æ­¤æ—¶ DOM èŠ‚ç‚¹ p çš„å…„å¼ŸèŠ‚ç‚¹ä¸º liï¼Œè€Œ Fiber èŠ‚ç‚¹ p å¯¹åº”çš„å…„å¼Ÿ DOM èŠ‚ç‚¹ä¸º <code>fiberP.sibling.child</code>, å³ fiber p çš„å…„å¼Ÿ fiber Item çš„å­ fiber liã€‚</p>
<h5 id="update-effect">Update effect</h5>
<p>å½“ Fiber èŠ‚ç‚¹å«æœ‰ Update effectTagï¼Œæ„å‘³ç€è¯¥ Fiber èŠ‚ç‚¹éœ€è¦æ›´æ–°ã€‚è°ƒç”¨çš„æ–¹æ³•ä¸º commitWorkï¼Œä»–ä¼šæ ¹æ® Fiber.tag åˆ†åˆ«å¤„ç†ã€‚<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1441">code</a></p>
<h6 id="functioncomponent-mutation">FunctionComponent mutation</h6>
<p>å½“ fiber.tag ä¸º FunctionComponentï¼Œä¼šè°ƒç”¨ <a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L314">commitHookEffectListUnmount</a>ã€‚è¯¥æ–¹æ³•ä¼šéå† effectListï¼Œæ‰§è¡Œæ‰€æœ‰ useLayoutEffect hook çš„é”€æ¯å‡½æ•°ã€‚ï¼ˆmutation é˜¶æ®µä¼šæ‰§è¡Œ useLayoutEffect çš„é”€æ¯å‡½æ•°!ï¼‰</p>
<p>æ‰€è°“â€œé”€æ¯å‡½æ•°â€ï¼Œè§å¦‚ä¸‹ä¾‹å­ï¼š</p>
<pre><code class="language-js">useLayoutEffect(() =&gt; {
  // ...ä¸€äº›å‰¯ä½œç”¨é€»è¾‘

  return () =&gt; {
    // ...è¿™å°±æ˜¯é”€æ¯å‡½æ•°
  }
})
</code></pre>
<h6 id="hostcomponent-mutation">HostComponent mutation</h6>
<p>å½“ fiber.tag ä¸º HostComponentï¼Œä¼šè°ƒç”¨ <a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-dom/src/client/ReactDOMHostConfig.js#L423">commitUpdate</a>ã€‚</p>
<p>æœ€ç»ˆä¼šåœ¨ <a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-dom/src/client/ReactDOMComponent.js#L378">updateDOMProperties</a>ä¸­å°† <a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L229">render é˜¶æ®µ completeWork</a>ä¸­ä¸º Fiber èŠ‚ç‚¹èµ‹å€¼çš„ updateQueue å¯¹åº”çš„å†…å®¹æ¸²æŸ“åœ¨é¡µé¢ä¸Šã€‚</p>
<pre><code class="language-js">for (let i = 0; i &lt; updatePayload.length; i += 2) {
  const propKey = updatePayload[i]
  const propValue = updatePayload[i + 1]

  // å¤„ç† style
  if (propKey === STYLE) {
    setValueForStyles(domElement, propValue)
    // å¤„ç† DANGEROUSLY_SET_INNER_HTML
  } else if (propKey === DANGEROUSLY_SET_INNER_HTML) {
    setInnerHTML(domElement, propValue)
    // å¤„ç† children
  } else if (propKey === CHILDREN) {
    setTextContent(domElement, propValue)
  } else {
    // å¤„ç†å‰©ä½™ props
    setValueForProperty(domElement, propKey, propValue, isCustomComponentTag)
  }
}
</code></pre>
<h5 id="deletion-effect">Deletion effect</h5>
<p>fiber èŠ‚ç‚¹å«æœ‰ Deletion effectTagï¼Œæ„å‘³ç€è¯¥ fiber èŠ‚ç‚¹å¯¹åº”çš„ DOM èŠ‚ç‚¹éœ€è¦ä»é¡µé¢ä¸­åˆ é™¤ï¼Œè°ƒç”¨çš„æ–¹æ³•ä¸º <a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1421">commitDeletion</a></p>
<p>è¯¥æ–¹æ³•ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>é€’å½’è°ƒç”¨ Fiber èŠ‚ç‚¹åŠå…¶å­å­™ Fiber èŠ‚ç‚¹ä¸­ï¼Œfiber.tag ä¸º ClassComponent çš„ <a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L920">componentWillUnmount</a>ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä»é¡µé¢ç§»é™¤ Fiber èŠ‚ç‚¹å¯¹åº” DOM èŠ‚ç‚¹</li>
<li>è§£ç»‘ ref</li>
<li>è°ƒåº¦ useEffect çš„é”€æ¯å‡½æ•°</li>
</ol>
<h3 id="layout-é˜¶æ®µ">layout é˜¶æ®µ</h3>
<p>ä¹‹æ‰€ä»¥ç§°ä¸º layout é˜¶æ®µï¼Œæ˜¯å› ä¸ºè¯¥é˜¶æ®µçš„ä»£ç éƒ½æ˜¯åœ¨ DOM æ¸²æŸ“å®Œæˆä¹‹åæ‰§è¡Œçš„ã€‚è¯¥é˜¶æ®µè§¦å‘çš„ç”Ÿå‘½å‘¨æœŸé’©å­å’Œ hook èƒ½ç›´æ¥è®¿é—®åˆ°æ”¹å˜åçš„ DOMï¼Œå³è¯¥é˜¶æ®µæ˜¯å¯ä»¥å‚ä¸ DOM layout çš„é˜¶æ®µã€‚</p>
<p>ç±»ä¼¼å‰ä¸¤ä¸ªé˜¶æ®µï¼Œè¯¥é˜¶æ®µä¹Ÿæ˜¯éå† effectListï¼Œæ‰§è¡Œå‡½æ•°ã€‚</p>
<p>å…·ä½“æ‰§è¡Œå‡½æ•°æ˜¯ commitLayoutEffectsã€‚</p>
<pre><code class="language-js">root.current = finishedWork

nextEffect = firstEffect
do {
  try {
    commitLayoutEffects(root, lanes)
  } catch (error) {
    invariant(nextEffect !== null, &#39;Should be working on an effect.&#39;)
    captureCommitPhaseError(nextEffect, error)
    nextEffect = nextEffect.nextEffect
  }
} while (nextEffect !== null)

nextEffect = null
</code></pre>
<h4 id="commitlayouteffects">commitLayoutEffects</h4>
<p><a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2302">æºç </a></p>
<pre><code class="language-js">function commitLayoutEffects(root: FiberRoot, committedLanes: Lanes) {
  while (nextEffect !== null) {
    const effectTag = nextEffect.effectTag

    // è°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­å’Œhook
    if (effectTag &amp; (Update | Callback)) {
      const current = nextEffect.alternate
      commitLayoutEffectOnFiber(root, current, nextEffect, committedLanes)
    }

    // èµ‹å€¼ref
    if (effectTag &amp; Ref) {
      commitAttachRef(nextEffect)
    }

    nextEffect = nextEffect.nextEffect
  }
}
</code></pre>
<p>commitLayoutEffects åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>commitLayoutEffectOnFiberï¼ˆè°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­å’Œ hook ç›¸å…³æ“ä½œï¼‰</li>
<li>commitAttachRefï¼ˆèµ‹å€¼ refï¼‰</li>
</ol>
<h5 id="commitlayouteffectonfiber">commitLayoutEffectOnFiber</h5>
<p><a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L459">commitLayoutEffectOnFiber</a> æ˜¯åˆ«åï¼ŒåŸåä¸º commitLifeCyclesã€‚</p>
<ul>
<li>å¯¹äº ClassComponentï¼Œä»–ä¼šé€šè¿‡ current === null?åŒºåˆ†æ˜¯ mount è¿˜æ˜¯ updateï¼Œè°ƒç”¨ componentDidMount (opens new window)æˆ– componentDidUpdateã€‚</li>
</ul>
<p>è§¦å‘çŠ¶æ€æ›´æ–°çš„ <code>this.setState</code> å¦‚æœèµ‹å€¼äº†ç¬¬äºŒä¸ªå‚æ•°å›è°ƒå‡½æ•°ï¼Œä¹Ÿä¼šåœ¨æ­¤æ—¶è°ƒç”¨ã€‚</p>
<pre><code class="language-js">this.setState({ xxx: 1 }, () =&gt; {
  console.log(&#39;i am update~&#39;)
})
</code></pre>
<ul>
<li>å¯¹äº FunctionComponent åŠç›¸å…³ç±»å‹ï¼Œä»–ä¼šè°ƒç”¨ useLayoutEffect hook çš„å›è°ƒå‡½æ•°ï¼Œè°ƒåº¦ useEffect çš„é”€æ¯ä¸å›è°ƒå‡½æ•°ã€‚
ç›¸å…³ç±»å‹å€¼ç‰¹æ®Šå¤„ç†åçš„ FunctionComponentï¼Œæ¯”å¦‚ ForwardRefã€React.memo åŒ…è£¹çš„ FunctionComponentã€‚</li>
</ul>
<pre><code class="language-js">switch (finishedWork.tag) {
  // ä»¥ä¸‹éƒ½æ˜¯FunctionComponentåŠç›¸å…³ç±»å‹
  case FunctionComponent:
  case ForwardRef:
  case SimpleMemoComponent:
  case Block: {
    // æ‰§è¡ŒuseLayoutEffectçš„å›è°ƒå‡½æ•°
    commitHookEffectListMount(HookLayout | HookHasEffect, finishedWork)
    // è°ƒåº¦useEffectçš„é”€æ¯å‡½æ•°ä¸å›è°ƒå‡½æ•°
    schedulePassiveEffects(finishedWork)
    return
  }
}
</code></pre>
<p>åœ¨ä¸Šä¸€èŠ‚ä»‹ç» update effect æ—¶è®²åˆ°ï¼Œmutation é˜¶æ®µä¼šæ‰§è¡Œ useLayoutEffect hook çš„é”€æ¯å‡½æ•°ã€‚</p>
<p>ç»“åˆè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼ŒuseLayoutEffect hook ä»ä¸Šä¸€æ¬¡æ›´æ–°çš„é”€æ¯å‡½æ•°è°ƒç”¨åˆ°æœ¬æ¬¡æ›´æ–°çš„å›è°ƒå‡½æ•°è°ƒç”¨æ—¶åŒæ­¥æ‰§è¡Œçš„ã€‚</p>
<p>è€Œ useEffect åˆ™éœ€è¦å…ˆè°ƒåº¦ï¼Œåœ¨ layout é˜¶æ®µå®Œæˆåå†å¼‚æ­¥æ‰§è¡Œã€‚</p>
<ul>
<li>å¯¹äº HostRootï¼Œå³ rootFiberï¼Œå¦‚æœèµ‹å€¼äº†ç¬¬ä¸‰ä¸ªå‚æ•°å›è°ƒå‡½æ•°ï¼Œä¹Ÿä¼šåœ¨æ­¤æ—¶è°ƒç”¨ã€‚</li>
</ul>
<pre><code class="language-js">ReactDOM.render(&lt;App /&gt;, document.querySelector(&#39;#root&#39;), function () {
  console.log(&#39;i am mount~&#39;)
})
</code></pre>
<h5 id="commitattachref">commitAttachRef</h5>
<p><a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L823">code</a></p>
<pre><code class="language-js">function commitAttachRef(finishedWork: Fiber) {
  const ref = finishedWork.ref
  if (ref !== null) {
    const instance = finishedWork.stateNode
    // è·å– DOM å®ä¾‹
    let instanceToUse
    switch (finishedWork.tag) {
      case HostComponent:
        instanceToUse = getPublicInstance(instance)
        break
      default:
        instanceToUse = instance
    }
    // Moved outside to ensure DCE works with this flag
    if (enableScopeAPI &amp;&amp; finishedWork.tag === ScopeComponent) {
      instanceToUse = instance
    }
    // æ›´æ–° ref
    if (typeof ref === &#39;function&#39;) {
      ref(instanceToUse)
    } else {
      ref.current = instanceToUse
    }
  }
}
</code></pre>
<h3 id="current-fiber-æ ‘åˆ‡æ¢">current Fiber æ ‘åˆ‡æ¢</h3>
<p>è‡³æ­¤ï¼Œæ•´ä¸ª layout é˜¶æ®µå°±ç»“æŸäº†ã€‚<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2022">code</a></p>
<pre><code class="language-js">root.current = finishedWork
</code></pre>
<p>workInProgress Fiber æ ‘åœ¨ commit é˜¶æ®µå®Œæˆæ¸²æŸ“åä¼šå˜ä¸º current Fiber æ ‘ã€‚è¿™è¡Œä»£ç çš„ä½œç”¨å°±æ˜¯åˆ‡æ¢ fiberRootNode æŒ‡å‘çš„ current Fiber æ ‘ã€‚</p>
<p>é‚£ä¹ˆè¿™è¡Œä»£ç ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œå‘¢ï¼Ÿï¼ˆåœ¨ mutation é˜¶æ®µç»“æŸåï¼Œlayout é˜¶æ®µå¼€å§‹å‰ã€‚ï¼‰</p>
<p>æˆ‘ä»¬çŸ¥é“ componentWillUnmount ä¼šåœ¨ mutation é˜¶æ®µæ‰§è¡Œã€‚æ­¤æ—¶ current Fiber æ ‘è¿˜æŒ‡å‘å‰ä¸€æ¬¡æ›´æ–°çš„ Fiber æ ‘ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸé’©å­å†…è·å–çš„ DOM è¿˜æ˜¯æ›´æ–°å‰çš„ã€‚</p>
<p>componentDidMount å’Œ componentDidUpdate ä¼šåœ¨ layout é˜¶æ®µæ‰§è¡Œã€‚æ­¤æ—¶ current Fiber æ ‘å·²ç»æŒ‡å‘æ›´æ–°åçš„ Fiber æ ‘ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸé’©å­å†…è·å–çš„ DOM å°±æ˜¯æ›´æ–°åçš„ã€‚</p>
</section></article></div><aside class="panel"><ul class="panel-list panel-list--gray"><li><input type="radio" id="font-classic" value="heti--classic" name="font" checked=""/><label for="font-classic">ä¼ ç»Ÿ</label></li><li><input type="radio" id="font-sans" value="heti--sans" name="font"/><label for="font-sans">é»‘ä½“</label></li><li><input type="radio" id="font-serif" value="heti--serif" name="font"/><label for="font-serif">å®‹ä½“</label></li></ul><ul class="panel-list panel-list--gray panel-list--icon"><li><input type="radio" value="auto" name="darkmode" id="darkmode-auto"/><label for="darkmode-auto">ğŸŒ—</label></li><li><input type="radio" value="light" name="darkmode" id="darkmode-light"/><label for="darkmode-light">ğŸŒ</label></li><li><input type="radio" value="dark" name="darkmode" id="darkmode-dark" checked=""/><label for="darkmode-dark">ğŸŒ™</label></li></ul></aside></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"React æ¶æ„","date":"2021-12-23 22:35:09","excerpt":"React çš„æ¶æ„ä»¥åŠ render å’Œ commit é˜¶æ®µ"},"slug":"React","content":"\n## React çš„æ¶æ„å¤§æ¦‚åˆ†ä¸º\n\n- Schedulerï¼ˆè°ƒåº¦å™¨ï¼‰â€”â€” è°ƒåº¦ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜ä»»åŠ¡ä¼˜å…ˆè¿›å…¥ Reconciler\n- Reconcilerï¼ˆåè°ƒå™¨ï¼‰â€”â€” è´Ÿè´£æ‰¾å‡ºå˜åŒ–çš„ç»„ä»¶\n- Rendererï¼ˆæ¸²æŸ“å™¨ï¼‰â€”â€” è´Ÿè´£å°†å˜åŒ–çš„ç»„ä»¶æ¸²æŸ“åˆ°é¡µé¢ä¸Š\n\nReconciler å·¥ä½œçš„é˜¶æ®µè¢«ç§°ä¸º render é˜¶æ®µã€‚å› ä¸ºåœ¨è¯¥é˜¶æ®µä¼šè°ƒç”¨ç»„ä»¶çš„ render æ–¹æ³•ã€‚\nRenderer å·¥ä½œçš„é˜¶æ®µè¢«ç§°ä¸º commit é˜¶æ®µã€‚å°±åƒä½ å®Œæˆä¸€ä¸ªéœ€æ±‚çš„ç¼–ç åæ‰§è¡Œ git commit æäº¤ä»£ç ã€‚commit é˜¶æ®µä¼šæŠŠ render é˜¶æ®µæäº¤çš„ä¿¡æ¯æ¸²æŸ“åœ¨é¡µé¢ä¸Šã€‚\nrender ä¸ commit é˜¶æ®µç»Ÿç§°ä¸º workï¼Œå³ React åœ¨å·¥ä½œä¸­ã€‚ç›¸å¯¹åº”çš„ï¼Œå¦‚æœä»»åŠ¡æ­£åœ¨ Scheduler å†…è°ƒåº¦ï¼Œå°±ä¸å±äº workã€‚\n\n## Render é˜¶æ®µ\n\nRender é˜¶æ®µå¼€å§‹äº performSyncWorkOnRoot æˆ– performConcurrentWorkOnRoot æ–¹æ³•çš„è°ƒç”¨ã€‚è¿™å–å†³äºæœ¬æ¬¡æ›´æ–°æ˜¯åŒæ­¥æ›´æ–°è¿˜æ˜¯å¼‚æ­¥æ›´æ–°ã€‚\n\n```js\n// performSyncWorkOnRootä¼šè°ƒç”¨è¯¥æ–¹æ³•\nfunction workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress)\n  }\n}\n\n// performConcurrentWorkOnRootä¼šè°ƒç”¨è¯¥æ–¹æ³•\nfunction workLoopConcurrent() {\n  while (workInProgress !== null \u0026\u0026 !shouldYield()) {\n    performUnitOfWork(workInProgress)\n  }\n}\n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œä»–ä»¬å”¯ä¸€çš„åŒºåˆ«æ˜¯æ˜¯å¦è°ƒç”¨ shouldYieldã€‚å¦‚æœå½“å‰æµè§ˆå™¨å¸§æ²¡æœ‰å‰©ä½™æ—¶é—´ï¼ŒshouldYield ä¼šä¸­æ­¢å¾ªç¯ï¼Œç›´åˆ°æµè§ˆå™¨æœ‰ç©ºé—²æ—¶é—´åå†ç»§ç»­éå†ã€‚\n\nworkInProgress ä»£è¡¨å½“å‰å·²åˆ›å»ºçš„ workInProgress fiberã€‚\n\nperformUnitOfWork æ–¹æ³•ä¼šåˆ›å»ºä¸‹ä¸€ä¸ª Fiber èŠ‚ç‚¹å¹¶èµ‹å€¼ç»™ workInProgressï¼Œå¹¶å°† workInProgress ä¸å·²åˆ›å»ºçš„ Fiber èŠ‚ç‚¹è¿æ¥èµ·æ¥æ„æˆ Fiber æ ‘ã€‚\n\næˆ‘ä»¬çŸ¥é“ Fiber Reconciler æ˜¯ä» Stack Reconciler é‡æ„è€Œæ¥ï¼Œé€šè¿‡éå†çš„æ–¹å¼å®ç°å¯ä¸­æ–­çš„é€’å½’ï¼Œæ‰€ä»¥ performUnitOfWork çš„å·¥ä½œå¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šâ€œé€’â€å’Œâ€œå½’â€\n\n### â€œé€’â€é˜¶æ®µ\n\né¦–å…ˆä» rootFiber å¼€å§‹å‘ä¸‹æ·±åº¦ä¼˜å…ˆéå†ã€‚ä¸ºéå†åˆ°çš„æ¯ä¸ª Fiber èŠ‚ç‚¹è°ƒç”¨ beginWork æ–¹æ³•ã€‚\nè¯¥æ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥çš„ Fiber èŠ‚ç‚¹åˆ›å»ºå­ Fiber èŠ‚ç‚¹ï¼Œå¹¶å°†è¿™ä¸¤ä¸ª Fiber èŠ‚ç‚¹è¿æ¥èµ·æ¥ã€‚\nå½“éå†åˆ°å¶å­èŠ‚ç‚¹ï¼ˆå³æ²¡æœ‰å­ç»„ä»¶çš„ç»„ä»¶ï¼‰æ—¶å°±ä¼šè¿›å…¥â€œå½’â€é˜¶æ®µã€‚\n\n### â€œå½’â€é˜¶æ®µ\n\nåœ¨â€œå½’â€é˜¶æ®µä¼šè°ƒç”¨ completeWork å¤„ç† Fiber èŠ‚ç‚¹ã€‚\nå½“æŸä¸ª Fiber èŠ‚ç‚¹æ‰§è¡Œå®Œ completeWorkï¼Œ\nå¦‚æœå…¶å­˜åœ¨å…„å¼Ÿ Fiber èŠ‚ç‚¹ï¼ˆå³ fiber.sibling !== nullï¼‰ï¼Œä¼šè¿›å…¥å…¶å…„å¼Ÿ Fiber çš„â€œé€’â€é˜¶æ®µã€‚\nå¦‚æœä¸å­˜åœ¨å…„å¼Ÿ Fiberï¼Œä¼šè¿›å…¥çˆ¶çº§ Fiber çš„â€œå½’â€é˜¶æ®µã€‚\n\nâ€œé€’â€å’Œâ€œå½’â€é˜¶æ®µä¼šäº¤é”™æ‰§è¡Œç›´åˆ°â€œå½’â€åˆ° rootFiberã€‚è‡³æ­¤ï¼Œrender é˜¶æ®µçš„å·¥ä½œå°±ç»“æŸäº†ã€‚\n\nrender é˜¶æ®µå…¨éƒ¨å·¥ä½œå®Œæˆã€‚åœ¨ performSyncWorkOnRoot å‡½æ•°ä¸­ fiberRootNode è¢«ä¼ é€’ç»™ commitRoot æ–¹æ³•ï¼Œå¼€å¯ commit é˜¶æ®µå·¥ä½œæµç¨‹ã€‚\n\n## Commit é˜¶æ®µ\n\ncommitRoot æ–¹æ³•æ˜¯ commit é˜¶æ®µå·¥ä½œçš„èµ·ç‚¹ã€‚fiberRootNode ä¼šä½œä¸ºä¼ å‚ã€‚\n\n```js\ncommitRoot(root)\n```\n\nåœ¨ rootFiber.firstEffect ä¸Šä¿å­˜äº†ä¸€æ¡éœ€è¦æ‰§è¡Œå‰¯ä½œç”¨çš„ Fiber èŠ‚ç‚¹çš„å•å‘é“¾è¡¨ effectListï¼Œè¿™äº› Fiber èŠ‚ç‚¹çš„ updateQueue ä¸­ä¿å­˜äº†å˜åŒ–çš„ propsã€‚\n\nè¿™äº›å‰¯ä½œç”¨å¯¹åº”çš„ DOM æ“ä½œåœ¨ commit é˜¶æ®µæ‰§è¡Œã€‚\n\né™¤æ­¤ä¹‹å¤–ï¼Œä¸€äº›ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆæ¯”å¦‚ componentDidXXXï¼‰ã€hookï¼ˆæ¯”å¦‚ useEffectï¼‰éœ€è¦åœ¨ commit é˜¶æ®µæ‰§è¡Œã€‚\n\ncommit é˜¶æ®µçš„ä¸»è¦å·¥ä½œï¼ˆå³ Renderer çš„å·¥ä½œæµç¨‹ï¼‰åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š\n\n- before mutation é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œå‰ï¼‰\n- mutation é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œï¼‰\n- layout é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œåï¼‰\n\nåœ¨ before mutation é˜¶æ®µä¹‹å‰å’Œ layout é˜¶æ®µä¹‹åè¿˜æœ‰ä¸€äº›é¢å¤–å·¥ä½œï¼Œæ¶‰åŠåˆ°æ¯”å¦‚ useEffect çš„è§¦å‘ã€ä¼˜å…ˆçº§ç›¸å…³çš„é‡ç½®ã€ref çš„ç»‘å®š/è§£ç»‘ã€‚\n\n### before mutation ä¹‹å‰\n\ncommitRootImpl æ–¹æ³•ä¸­ç›´åˆ°ç¬¬ä¸€å¥ `if (firstEffect !== null)` ä¹‹å‰å±äº before mutation ä¹‹å‰ã€‚\n\nbefore mutation ä¹‹å‰ä¸»è¦åšä¸€äº›å˜é‡èµ‹å€¼ï¼ŒçŠ¶æ€é‡ç½®çš„å·¥ä½œã€‚\n\n### layout ä¹‹å\n\nä¸»è¦åŒ…æ‹¬ä¸‰ç‚¹å†…å®¹ï¼š\n\n- useEffect ç›¸å…³çš„å¤„ç†ã€‚\n- æ€§èƒ½è¿½è¸ªç›¸å…³ã€‚\n  æºç é‡Œæœ‰å¾ˆå¤šå’Œ interaction ç›¸å…³çš„å˜é‡ã€‚ä»–ä»¬éƒ½å’Œè¿½è¸ª React æ¸²æŸ“æ—¶é—´ã€æ€§èƒ½ç›¸å…³ï¼Œåœ¨ Profiler API å’Œ DevTools ä¸­ä½¿ç”¨ã€‚\n- åœ¨ commit é˜¶æ®µä¼šè§¦å‘ä¸€äº›ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå¦‚ componentDidXXXï¼‰å’Œ hookï¼ˆå¦‚ useLayoutEffectã€useEffectï¼‰ã€‚\n\nåœ¨è¿™äº›å›è°ƒæ–¹æ³•ä¸­å¯èƒ½è§¦å‘æ–°çš„æ›´æ–°ï¼Œæ–°çš„æ›´æ–°ä¼šå¼€å¯æ–°çš„ render-commit æµç¨‹ã€‚\n\n### before mutation\n\nbefore mutation é˜¶æ®µçš„ä»£ç å¾ˆçŸ­ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯éå† effectList å¹¶è°ƒç”¨ commitBeforeMutationEffects å‡½æ•°å¤„ç†ã€‚\n\n#### commitBeforeMutationEffects\n\næ•´ä½“å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š\n\n1. å¤„ç† DOM èŠ‚ç‚¹æ¸²æŸ“/åˆ é™¤åçš„ autoFocusã€blur é€»è¾‘ã€‚\n2. è°ƒç”¨ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚\n3. è°ƒåº¦ useEffectã€‚\n\n##### è°ƒç”¨ getSnapshotBeforeUpdate\n\nä» Reactv16 å¼€å§‹ï¼ŒcomponentWillXXX é’©å­å‰å¢åŠ äº† UNSAFE\\_ å‰ç¼€ã€‚\n\nç©¶å…¶åŸå› ï¼Œæ˜¯å› ä¸º Stack Reconciler é‡æ„ä¸º Fiber Reconciler åï¼Œrender é˜¶æ®µçš„ä»»åŠ¡å¯èƒ½ä¸­æ–­/é‡æ–°å¼€å§‹ï¼Œå¯¹åº”çš„ç»„ä»¶åœ¨ render é˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå³ componentWillXXX ï¼‰å¯èƒ½è§¦å‘å¤šæ¬¡ã€‚\n\nä¸ºæ­¤ï¼ŒReact æä¾›äº†æ›¿ä»£çš„ç”Ÿå‘½å‘¨æœŸé’©å­ getSnapshotBeforeUpdateï¼Œå¯ç”¨äºæ›¿æ¢ç°æœ‰çš„ componentWillUnMountã€‚\n\næˆ‘ä»¬å¯ä»¥çœ‹è§ï¼ŒgetSnapshotBeforeUpdate æ˜¯åœ¨ commit é˜¶æ®µå†…çš„ before mutation é˜¶æ®µè°ƒç”¨çš„ï¼Œç”±äº commit é˜¶æ®µæ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥ä¸ä¼šé‡åˆ°å¤šæ¬¡è°ƒç”¨çš„é—®é¢˜ã€‚\n\n##### è°ƒåº¦ useEffect\n\nscheduler çš„ scheduleCallbackï¼Œç”¨äºä»¥æŸä¸ªä¼˜å…ˆçº§å¼‚æ­¥è°ƒåº¦ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚\n\n```js\n// è°ƒåº¦useEffect\nif ((effectTag \u0026 Passive) !== NoEffect) {\n  if (!rootDoesHavePassiveEffects) {\n    rootDoesHavePassiveEffects = true\n    scheduleCallback(NormalSchedulerPriority, () =\u003e {\n      // è§¦å‘useEffect\n      flushPassiveEffects()\n      return null\n    })\n  }\n}\n```\n\nè¢«å¼‚æ­¥è°ƒåº¦çš„å›è°ƒå‡½æ•°å°±æ˜¯è§¦å‘ useEffect çš„æ–¹æ³• flushPassiveEffectsã€‚ä¸‹é¢çœ‹çœ‹ä¸º useEffect å¦‚ä½•ä»¥åŠä¸ºä½•è¢«å¼‚æ­¥è°ƒåº¦ã€‚\n\n##### å¦‚ä½•å¼‚æ­¥è°ƒåº¦ useEffect\n\nflushPassiveEffects æ–¹æ³•å†…éƒ¨ä¼šä»å…¨å±€å˜é‡ rootWithPendingPassiveEffects è·å– effectListã€‚\n\neffectList ä¸­ä¿å­˜äº†éœ€è¦æ‰§è¡Œå‰¯ä½œç”¨çš„ Fiber èŠ‚ç‚¹ã€‚å…¶ä¸­å‰¯ä½œç”¨åŒ…æ‹¬\n\n- æ’å…¥ DOM èŠ‚ç‚¹ï¼ˆPlacementï¼‰\n- æ›´æ–° DOM èŠ‚ç‚¹ï¼ˆUpdateï¼‰\n- åˆ é™¤ DOM èŠ‚ç‚¹ï¼ˆDeletionï¼‰\n\nå…³äº flushPassiveEffects çš„å…·ä½“è®²è§£å‚ç…§ useEffect ä¸ useLayoutEffect ä¸€èŠ‚\n\neffectList ä¸­ä¿å­˜äº†éœ€è¦æ‰§è¡Œå‰¯ä½œç”¨çš„ Fiber èŠ‚ç‚¹ã€‚å…¶ä¸­å‰¯ä½œç”¨åŒ…æ‹¬\n\n- æ’å…¥ DOM èŠ‚ç‚¹ï¼ˆPlacementï¼‰\n- æ›´æ–° DOM èŠ‚ç‚¹ï¼ˆUpdateï¼‰\n- åˆ é™¤ DOM èŠ‚ç‚¹ï¼ˆDeletionï¼‰\n\nå½“ä¸€ä¸ª FunctionComponent å«æœ‰ useEffect æˆ– useLayoutEffectï¼Œä»–å¯¹åº”çš„ Fiber èŠ‚ç‚¹ä¹Ÿä¼šè¢«èµ‹å€¼ effectTagã€‚\n\næ•´ä¸ª useEffect å¼‚æ­¥è°ƒç”¨åˆ†ä¸ºä¸‰æ­¥ï¼š\n\n- before mutation é˜¶æ®µåœ¨ scheduleCallback ä¸­è°ƒåº¦ flushPassiveEffects\n- layout é˜¶æ®µä¹‹åå°† effectList èµ‹å€¼ç»™ rootWithPendingPassiveEffects\n- scheduleCallback è§¦å‘ flushPassiveEffectsï¼ŒflushPassiveEffects å†…éƒ¨éå† rootWithPendingPassiveEffects\n\nä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥è°ƒç”¨\næ‘˜å½•è‡ª React æ–‡æ¡£ effect çš„æ‰§è¡Œæ—¶æœºï¼š\n\nä¸ componentDidMountã€componentDidUpdate ä¸åŒçš„æ˜¯ï¼Œåœ¨æµè§ˆå™¨å®Œæˆå¸ƒå±€ä¸ç»˜åˆ¶ä¹‹åï¼Œä¼ ç»™ useEffect çš„å‡½æ•°ä¼šå»¶è¿Ÿè°ƒç”¨ã€‚è¿™ä½¿å¾—å®ƒé€‚ç”¨äºè®¸å¤šå¸¸è§çš„å‰¯ä½œç”¨åœºæ™¯ï¼Œæ¯”å¦‚è®¾ç½®è®¢é˜…å’Œäº‹ä»¶å¤„ç†ç­‰æƒ…å†µï¼Œå› æ­¤ä¸åº”åœ¨å‡½æ•°ä¸­æ‰§è¡Œé˜»å¡æµè§ˆå™¨æ›´æ–°å±å¹•çš„æ“ä½œã€‚\n\nå¯è§ï¼ŒuseEffect å¼‚æ­¥æ‰§è¡Œçš„åŸå› ä¸»è¦æ˜¯**é˜²æ­¢åŒæ­¥æ‰§è¡Œæ—¶é˜»å¡æµè§ˆå™¨æ¸²æŸ“**ã€‚\n\n### mutation é˜¶æ®µ\n\nmutation é˜¶æ®µä¹Ÿæ˜¯éå† effectListï¼Œæ‰§è¡Œå‡½æ•°ã€‚è¿™é‡Œæ‰§è¡Œçš„æ˜¯ commitMutationEffectsã€‚\n\n```js\nnextEffect = firstEffect\ndo {\n  try {\n    commitMutationEffects(root, renderPriorityLevel)\n  } catch (error) {\n    invariant(nextEffect !== null, 'Should be working on an effect.')\n    captureCommitPhaseError(nextEffect, error)\n    nextEffect = nextEffect.nextEffect\n  }\n} while (nextEffect !== null)\n```\n\n#### commitMutationEffects\n\n```js\nfunction commitMutationEffects(root: FiberRoot, renderPriorityLevel) {\n  // éå†effectList\n  while (nextEffect !== null) {\n    const effectTag = nextEffect.effectTag\n\n    // æ ¹æ® ContentReset effectTagé‡ç½®æ–‡å­—èŠ‚ç‚¹\n    if (effectTag \u0026 ContentReset) {\n      commitResetTextContent(nextEffect)\n    }\n\n    // æ›´æ–°ref\n    if (effectTag \u0026 Ref) {\n      const current = nextEffect.alternate\n      if (current !== null) {\n        commitDetachRef(current)\n      }\n    }\n\n    // æ ¹æ® effectTag åˆ†åˆ«å¤„ç†\n    const primaryEffectTag =\n      effectTag \u0026 (Placement | Update | Deletion | Hydrating)\n    switch (primaryEffectTag) {\n      // æ’å…¥DOM\n      case Placement: {\n        commitPlacement(nextEffect)\n        // ~ å–å\n        nextEffect.effectTag \u0026= ~Placement\n        break\n      }\n      // æ’å…¥DOM å¹¶ æ›´æ–°DOM\n      case PlacementAndUpdate: {\n        // æ’å…¥\n        commitPlacement(nextEffect)\n\n        nextEffect.effectTag \u0026= ~Placement\n\n        // æ›´æ–°\n        // current        æ˜¯ç°åœ¨çš„ fiber\n        // workInProgress æ˜¯æ–°çš„ fiber\n        // alternate      å®ƒä»¬é€šè¿‡ alternate è¿æ¥\n        const current = nextEffect.alternate\n        commitWork(current, nextEffect)\n        break\n      }\n      // SSR\n      case Hydrating: {\n        nextEffect.effectTag \u0026= ~Hydrating\n        break\n      }\n      // SSR\n      case HydratingAndUpdate: {\n        nextEffect.effectTag \u0026= ~Hydrating\n\n        const current = nextEffect.alternate\n        commitWork(current, nextEffect)\n        break\n      }\n      // æ›´æ–°DOM\n      case Update: {\n        const current = nextEffect.alternate\n        commitWork(current, nextEffect)\n        break\n      }\n      // åˆ é™¤DOM\n      case Deletion: {\n        commitDeletion(root, nextEffect, renderPriorityLevel)\n        break\n      }\n    }\n\n    nextEffect = nextEffect.nextEffect\n  }\n}\n```\n\ncommitMutationEffects ä¼šéå† effectListï¼Œå¯¹æ¯ä¸ª Fiber èŠ‚ç‚¹æ‰§è¡Œå¦‚ä¸‹ä¸‰ä¸ªæ“ä½œï¼š\n\n- æ ¹æ® ContentReset effectTag é‡ç½®æ–‡å­—èŠ‚ç‚¹\n- æ›´æ–° ref\n- æ ¹æ® effectTag åˆ†åˆ«å¤„ç†ï¼Œå…¶ä¸­ effectTag åŒ…æ‹¬(Placement | Update | Deletion | Hydrating)\n\n##### Placement effect\n\nå½“ Fiber èŠ‚ç‚¹å«æœ‰ Placement effectTagï¼Œæ„å‘³ç€è¯¥ Fiber èŠ‚ç‚¹å¯¹åº”çš„ DOM èŠ‚ç‚¹éœ€è¦æ’å…¥åˆ°é¡µé¢ä¸­ã€‚[code](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1156)\n\n1. è·å–çˆ¶çº§ DOM èŠ‚ç‚¹ã€‚å…¶ä¸­ finishedWork ä¸ºä¼ å…¥çš„ Fiber èŠ‚ç‚¹ã€‚\n\n   ```js\n   const parentFiber = getHostParentFiber(finishedWork)\n   // çˆ¶çº§DOMèŠ‚ç‚¹\n   const parentStateNode = parentFiber.stateNode\n   ```\n\n2. è·å– Fiber èŠ‚ç‚¹çš„ DOM å…„å¼ŸèŠ‚ç‚¹\n\n   ```js\n   const before = getHostSibling(finishedWork)\n   ```\n\n3. æ ¹æ® DOM å…„å¼ŸèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨å†³å®šè°ƒç”¨ parentNode.insertBefore æˆ– parentNode.appendChild æ‰§è¡Œ DOM æ’å…¥æ“ä½œã€‚\n\n   ```js\n   // parentStateNodeæ˜¯å¦æ˜¯rootFiber\n   if (isContainer) {\n     insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent)\n   } else {\n     insertOrAppendPlacementNode(finishedWork, before, parent)\n   }\n   ```\n\nå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒgetHostSiblingï¼ˆè·å–å…„å¼Ÿ DOM èŠ‚ç‚¹ï¼‰çš„æ‰§è¡Œå¾ˆè€—æ—¶ï¼Œå½“åœ¨åŒä¸€ä¸ªçˆ¶ Fiber èŠ‚ç‚¹ä¸‹ä¾æ¬¡æ‰§è¡Œå¤šä¸ªæ’å…¥æ“ä½œï¼ŒgetHostSibling ç®—æ³•çš„å¤æ‚åº¦ä¸ºæŒ‡æ•°çº§ã€‚\n\nè¿™æ˜¯ç”±äº Fiber èŠ‚ç‚¹ä¸åªåŒ…æ‹¬ HostComponentï¼Œæ‰€ä»¥ Fiber æ ‘å’Œæ¸²æŸ“çš„ DOM æ ‘èŠ‚ç‚¹å¹¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚è¦ä» Fiber èŠ‚ç‚¹æ‰¾åˆ° DOM èŠ‚ç‚¹å¾ˆå¯èƒ½è·¨å±‚çº§éå†ã€‚\n\nè€ƒè™‘å¦‚ä¸‹ä¾‹å­ï¼š\n\n```js\nfunction Item() {\n  return \u003cli\u003e\u003cli\u003e;\n}\n\nfunction App() {\n  return (\n    \u003cdiv\u003e\n      \u003cItem/\u003e\n    \u003c/div\u003e\n  )\n}\n\nReactDOM.render(\u003cApp/\u003e, document.getElementById('root'));\n```\n\nå¯¹åº”çš„ Fiber æ ‘å’Œ DOM æ ‘ç»“æ„ä¸ºï¼š\n\n```js\n// Fiberæ ‘\n          child      child      child       child\nrootFiber -----\u003e App -----\u003e div -----\u003e Item -----\u003e li\n\n// DOMæ ‘\n#root ---\u003e div ---\u003e li\n```\n\nå½“åœ¨ div çš„å­èŠ‚ç‚¹ Item å‰æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹ pï¼Œå³ App å˜ä¸ºï¼š\n\n```js\nfunction App() {\n  return (\n    \u003cdiv\u003e\n      \u003cp\u003e\u003c/p\u003e\n      \u003cItem /\u003e\n    \u003c/div\u003e\n  )\n}\n```\n\nå¯¹åº”çš„ Fiber æ ‘å’Œ DOM æ ‘ç»“æ„ä¸ºï¼š\n\n```js\n// Fiberæ ‘\n          child      child      child\nrootFiber -----\u003e App -----\u003e div -----\u003e p\n                                       | sibling       child\n                                       | -------\u003e Item -----\u003e li\n// DOMæ ‘\n#root ---\u003e div ---\u003e p\n             |\n               ---\u003e li\n```\n\næ­¤æ—¶ DOM èŠ‚ç‚¹ p çš„å…„å¼ŸèŠ‚ç‚¹ä¸º liï¼Œè€Œ Fiber èŠ‚ç‚¹ p å¯¹åº”çš„å…„å¼Ÿ DOM èŠ‚ç‚¹ä¸º `fiberP.sibling.child`, å³ fiber p çš„å…„å¼Ÿ fiber Item çš„å­ fiber liã€‚\n\n##### Update effect\n\nå½“ Fiber èŠ‚ç‚¹å«æœ‰ Update effectTagï¼Œæ„å‘³ç€è¯¥ Fiber èŠ‚ç‚¹éœ€è¦æ›´æ–°ã€‚è°ƒç”¨çš„æ–¹æ³•ä¸º commitWorkï¼Œä»–ä¼šæ ¹æ® Fiber.tag åˆ†åˆ«å¤„ç†ã€‚[code](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1441)\n\n###### FunctionComponent mutation\n\nå½“ fiber.tag ä¸º FunctionComponentï¼Œä¼šè°ƒç”¨ [commitHookEffectListUnmount](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L314)ã€‚è¯¥æ–¹æ³•ä¼šéå† effectListï¼Œæ‰§è¡Œæ‰€æœ‰ useLayoutEffect hook çš„é”€æ¯å‡½æ•°ã€‚ï¼ˆmutation é˜¶æ®µä¼šæ‰§è¡Œ useLayoutEffect çš„é”€æ¯å‡½æ•°!ï¼‰\n\næ‰€è°“â€œé”€æ¯å‡½æ•°â€ï¼Œè§å¦‚ä¸‹ä¾‹å­ï¼š\n\n```js\nuseLayoutEffect(() =\u003e {\n  // ...ä¸€äº›å‰¯ä½œç”¨é€»è¾‘\n\n  return () =\u003e {\n    // ...è¿™å°±æ˜¯é”€æ¯å‡½æ•°\n  }\n})\n```\n\n###### HostComponent mutation\n\nå½“ fiber.tag ä¸º HostComponentï¼Œä¼šè°ƒç”¨ [commitUpdate](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-dom/src/client/ReactDOMHostConfig.js#L423)ã€‚\n\næœ€ç»ˆä¼šåœ¨ [updateDOMProperties](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-dom/src/client/ReactDOMComponent.js#L378)ä¸­å°† [render é˜¶æ®µ completeWork](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L229)ä¸­ä¸º Fiber èŠ‚ç‚¹èµ‹å€¼çš„ updateQueue å¯¹åº”çš„å†…å®¹æ¸²æŸ“åœ¨é¡µé¢ä¸Šã€‚\n\n```js\nfor (let i = 0; i \u003c updatePayload.length; i += 2) {\n  const propKey = updatePayload[i]\n  const propValue = updatePayload[i + 1]\n\n  // å¤„ç† style\n  if (propKey === STYLE) {\n    setValueForStyles(domElement, propValue)\n    // å¤„ç† DANGEROUSLY_SET_INNER_HTML\n  } else if (propKey === DANGEROUSLY_SET_INNER_HTML) {\n    setInnerHTML(domElement, propValue)\n    // å¤„ç† children\n  } else if (propKey === CHILDREN) {\n    setTextContent(domElement, propValue)\n  } else {\n    // å¤„ç†å‰©ä½™ props\n    setValueForProperty(domElement, propKey, propValue, isCustomComponentTag)\n  }\n}\n```\n\n##### Deletion effect\n\nfiber èŠ‚ç‚¹å«æœ‰ Deletion effectTagï¼Œæ„å‘³ç€è¯¥ fiber èŠ‚ç‚¹å¯¹åº”çš„ DOM èŠ‚ç‚¹éœ€è¦ä»é¡µé¢ä¸­åˆ é™¤ï¼Œè°ƒç”¨çš„æ–¹æ³•ä¸º [commitDeletion](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1421)\n\nè¯¥æ–¹æ³•ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n\n1. é€’å½’è°ƒç”¨ Fiber èŠ‚ç‚¹åŠå…¶å­å­™ Fiber èŠ‚ç‚¹ä¸­ï¼Œfiber.tag ä¸º ClassComponent çš„ [componentWillUnmount](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L920)ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä»é¡µé¢ç§»é™¤ Fiber èŠ‚ç‚¹å¯¹åº” DOM èŠ‚ç‚¹\n2. è§£ç»‘ ref\n3. è°ƒåº¦ useEffect çš„é”€æ¯å‡½æ•°\n\n### layout é˜¶æ®µ\n\nä¹‹æ‰€ä»¥ç§°ä¸º layout é˜¶æ®µï¼Œæ˜¯å› ä¸ºè¯¥é˜¶æ®µçš„ä»£ç éƒ½æ˜¯åœ¨ DOM æ¸²æŸ“å®Œæˆä¹‹åæ‰§è¡Œçš„ã€‚è¯¥é˜¶æ®µè§¦å‘çš„ç”Ÿå‘½å‘¨æœŸé’©å­å’Œ hook èƒ½ç›´æ¥è®¿é—®åˆ°æ”¹å˜åçš„ DOMï¼Œå³è¯¥é˜¶æ®µæ˜¯å¯ä»¥å‚ä¸ DOM layout çš„é˜¶æ®µã€‚\n\nç±»ä¼¼å‰ä¸¤ä¸ªé˜¶æ®µï¼Œè¯¥é˜¶æ®µä¹Ÿæ˜¯éå† effectListï¼Œæ‰§è¡Œå‡½æ•°ã€‚\n\nå…·ä½“æ‰§è¡Œå‡½æ•°æ˜¯ commitLayoutEffectsã€‚\n\n```js\nroot.current = finishedWork\n\nnextEffect = firstEffect\ndo {\n  try {\n    commitLayoutEffects(root, lanes)\n  } catch (error) {\n    invariant(nextEffect !== null, 'Should be working on an effect.')\n    captureCommitPhaseError(nextEffect, error)\n    nextEffect = nextEffect.nextEffect\n  }\n} while (nextEffect !== null)\n\nnextEffect = null\n```\n\n#### commitLayoutEffects\n\n[æºç ](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2302)\n\n```js\nfunction commitLayoutEffects(root: FiberRoot, committedLanes: Lanes) {\n  while (nextEffect !== null) {\n    const effectTag = nextEffect.effectTag\n\n    // è°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­å’Œhook\n    if (effectTag \u0026 (Update | Callback)) {\n      const current = nextEffect.alternate\n      commitLayoutEffectOnFiber(root, current, nextEffect, committedLanes)\n    }\n\n    // èµ‹å€¼ref\n    if (effectTag \u0026 Ref) {\n      commitAttachRef(nextEffect)\n    }\n\n    nextEffect = nextEffect.nextEffect\n  }\n}\n```\n\ncommitLayoutEffects åšäº†ä¸¤ä»¶äº‹ï¼š\n\n1. commitLayoutEffectOnFiberï¼ˆè°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­å’Œ hook ç›¸å…³æ“ä½œï¼‰\n2. commitAttachRefï¼ˆèµ‹å€¼ refï¼‰\n\n##### commitLayoutEffectOnFiber\n\n[commitLayoutEffectOnFiber](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L459) æ˜¯åˆ«åï¼ŒåŸåä¸º commitLifeCyclesã€‚\n\n- å¯¹äº ClassComponentï¼Œä»–ä¼šé€šè¿‡ current === null?åŒºåˆ†æ˜¯ mount è¿˜æ˜¯ updateï¼Œè°ƒç”¨ componentDidMount (opens new window)æˆ– componentDidUpdateã€‚\n\nè§¦å‘çŠ¶æ€æ›´æ–°çš„ `this.setState` å¦‚æœèµ‹å€¼äº†ç¬¬äºŒä¸ªå‚æ•°å›è°ƒå‡½æ•°ï¼Œä¹Ÿä¼šåœ¨æ­¤æ—¶è°ƒç”¨ã€‚\n\n```js\nthis.setState({ xxx: 1 }, () =\u003e {\n  console.log('i am update~')\n})\n```\n\n- å¯¹äº FunctionComponent åŠç›¸å…³ç±»å‹ï¼Œä»–ä¼šè°ƒç”¨ useLayoutEffect hook çš„å›è°ƒå‡½æ•°ï¼Œè°ƒåº¦ useEffect çš„é”€æ¯ä¸å›è°ƒå‡½æ•°ã€‚\n  ç›¸å…³ç±»å‹å€¼ç‰¹æ®Šå¤„ç†åçš„ FunctionComponentï¼Œæ¯”å¦‚ ForwardRefã€React.memo åŒ…è£¹çš„ FunctionComponentã€‚\n\n```js\nswitch (finishedWork.tag) {\n  // ä»¥ä¸‹éƒ½æ˜¯FunctionComponentåŠç›¸å…³ç±»å‹\n  case FunctionComponent:\n  case ForwardRef:\n  case SimpleMemoComponent:\n  case Block: {\n    // æ‰§è¡ŒuseLayoutEffectçš„å›è°ƒå‡½æ•°\n    commitHookEffectListMount(HookLayout | HookHasEffect, finishedWork)\n    // è°ƒåº¦useEffectçš„é”€æ¯å‡½æ•°ä¸å›è°ƒå‡½æ•°\n    schedulePassiveEffects(finishedWork)\n    return\n  }\n}\n```\n\nåœ¨ä¸Šä¸€èŠ‚ä»‹ç» update effect æ—¶è®²åˆ°ï¼Œmutation é˜¶æ®µä¼šæ‰§è¡Œ useLayoutEffect hook çš„é”€æ¯å‡½æ•°ã€‚\n\nç»“åˆè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼ŒuseLayoutEffect hook ä»ä¸Šä¸€æ¬¡æ›´æ–°çš„é”€æ¯å‡½æ•°è°ƒç”¨åˆ°æœ¬æ¬¡æ›´æ–°çš„å›è°ƒå‡½æ•°è°ƒç”¨æ—¶åŒæ­¥æ‰§è¡Œçš„ã€‚\n\nè€Œ useEffect åˆ™éœ€è¦å…ˆè°ƒåº¦ï¼Œåœ¨ layout é˜¶æ®µå®Œæˆåå†å¼‚æ­¥æ‰§è¡Œã€‚\n\n- å¯¹äº HostRootï¼Œå³ rootFiberï¼Œå¦‚æœèµ‹å€¼äº†ç¬¬ä¸‰ä¸ªå‚æ•°å›è°ƒå‡½æ•°ï¼Œä¹Ÿä¼šåœ¨æ­¤æ—¶è°ƒç”¨ã€‚\n\n```js\nReactDOM.render(\u003cApp /\u003e, document.querySelector('#root'), function () {\n  console.log('i am mount~')\n})\n```\n\n##### commitAttachRef\n\n[code](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L823)\n\n```js\nfunction commitAttachRef(finishedWork: Fiber) {\n  const ref = finishedWork.ref\n  if (ref !== null) {\n    const instance = finishedWork.stateNode\n    // è·å– DOM å®ä¾‹\n    let instanceToUse\n    switch (finishedWork.tag) {\n      case HostComponent:\n        instanceToUse = getPublicInstance(instance)\n        break\n      default:\n        instanceToUse = instance\n    }\n    // Moved outside to ensure DCE works with this flag\n    if (enableScopeAPI \u0026\u0026 finishedWork.tag === ScopeComponent) {\n      instanceToUse = instance\n    }\n    // æ›´æ–° ref\n    if (typeof ref === 'function') {\n      ref(instanceToUse)\n    } else {\n      ref.current = instanceToUse\n    }\n  }\n}\n```\n\n### current Fiber æ ‘åˆ‡æ¢\n\nè‡³æ­¤ï¼Œæ•´ä¸ª layout é˜¶æ®µå°±ç»“æŸäº†ã€‚[code](https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2022)\n\n```js\nroot.current = finishedWork\n```\n\nworkInProgress Fiber æ ‘åœ¨ commit é˜¶æ®µå®Œæˆæ¸²æŸ“åä¼šå˜ä¸º current Fiber æ ‘ã€‚è¿™è¡Œä»£ç çš„ä½œç”¨å°±æ˜¯åˆ‡æ¢ fiberRootNode æŒ‡å‘çš„ current Fiber æ ‘ã€‚\n\né‚£ä¹ˆè¿™è¡Œä»£ç ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œå‘¢ï¼Ÿï¼ˆåœ¨ mutation é˜¶æ®µç»“æŸåï¼Œlayout é˜¶æ®µå¼€å§‹å‰ã€‚ï¼‰\n\næˆ‘ä»¬çŸ¥é“ componentWillUnmount ä¼šåœ¨ mutation é˜¶æ®µæ‰§è¡Œã€‚æ­¤æ—¶ current Fiber æ ‘è¿˜æŒ‡å‘å‰ä¸€æ¬¡æ›´æ–°çš„ Fiber æ ‘ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸé’©å­å†…è·å–çš„ DOM è¿˜æ˜¯æ›´æ–°å‰çš„ã€‚\n\ncomponentDidMount å’Œ componentDidUpdate ä¼šåœ¨ layout é˜¶æ®µæ‰§è¡Œã€‚æ­¤æ—¶ current Fiber æ ‘å·²ç»æŒ‡å‘æ›´æ–°åçš„ Fiber æ ‘ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸé’©å­å†…è·å–çš„ DOM å°±æ˜¯æ›´æ–°åçš„ã€‚\n"},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"React"},"buildId":"ZAv09URXGddjeP1v_KZGc","assetPrefix":"/next-blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>