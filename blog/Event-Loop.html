<!DOCTYPE html><html lang="zh-Hans"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/next-blog/_next/static/css/8543050952beacbd.css" as="style"/><link rel="stylesheet" href="/next-blog/_next/static/css/8543050952beacbd.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/next-blog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/next-blog/_next/static/chunks/webpack-3cfba94e1de595e3.js" defer=""></script><script src="/next-blog/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/next-blog/_next/static/chunks/main-1c9e93b8392c1bc9.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/_app-bc0777daea9f4a0d.js" defer=""></script><script src="/next-blog/_next/static/chunks/963-7455877b8d482f59.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/blog/%5Bslug%5D-2094ee9b50c39180.js" defer=""></script><script src="/next-blog/_next/static/axI5iBLAatQt5APucXB_j/_buildManifest.js" defer=""></script><script src="/next-blog/_next/static/axI5iBLAatQt5APucXB_j/_ssgManifest.js" defer=""></script><script src="/next-blog/_next/static/axI5iBLAatQt5APucXB_j/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><section class="p-12"><div><a href="/next-blog">Home</a><article class="article heti"><h1>Event Loop</h1><p><time class="heti-meta heti-small">2022-01-09 21:39:00</time></p><section><h2 id="å®šä¹‰">å®šä¹‰</h2>
<p>whatwg çš„æ ‡å‡†é‡Œé¢è®²äº†ï¼Œä¸ºäº†åè°ƒäº‹ä»¶ã€ç”¨æˆ·äº¤äº’ã€è„šæœ¬ã€æ¸²æŸ“ã€ç½‘ç»œç­‰ï¼Œç”¨æˆ·ä»£ç†å¿…é¡»ä½¿ç”¨äº‹ä»¶å¾ªç¯ã€‚æ¯ä¸ªä»£ç†éƒ½æœ‰ä¸€ä¸ªå…³è”çš„äº‹ä»¶å¾ªç¯ï¼Œè¿™æ˜¯è¯¥ä»£ç†ç‹¬æœ‰çš„ã€‚</p>
<blockquote>
<p>The event loop of a similar-origin window agent is known as a window event loop. The event loop of a dedicated worker agent, shared worker agent, or service worker agent is known as a worker event loop. And the event loop of a worklet agent is known as a worklet event loop.</p>
</blockquote>
<p>ä¸€ä¸ªäº‹ä»¶å¾ªç¯æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª task queuesã€‚ä¸€ä¸ª task queue æ˜¯ä¸€ä¸ª tasks setã€‚</p>
<blockquote>
<p>Task queues are sets, not queues, because step one of the event loop processing model grabs the first runnable task from the chosen queue, instead of dequeuing the first task.The microtask queue is not a task queue.</p>
</blockquote>
<h2 id="ä»»åŠ¡">ä»»åŠ¡</h2>
<p>ä»»åŠ¡å°è£…äº†å¦‚ä¸‹çš„ç®—æ³•ï¼š</p>
<ul>
<li>Event: æ´¾å‘ä¸€ä¸ªäº‹ä»¶ç»™ç‰¹å®šçš„ target ç»å¸¸æ˜¯ç”±ä¸“é—¨çš„ä»»åŠ¡å»å®Œæˆçš„ã€‚</li>
<li>Parsingï¼š HTML è§£æé€šå¸¸æ˜¯ä¸€ä¸ªä»»åŠ¡ã€‚</li>
<li>Callbacksï¼šè°ƒç”¨ä¸€ä¸ªå›è°ƒç»å¸¸æ˜¯ç”±ä¸€ä¸ªä¸“é—¨çš„ä»»åŠ¡å®Œæˆã€‚</li>
<li>Using a resource</li>
<li>Reacting to DOM manipulation: ä¸€äº›å…ƒç´ å…·æœ‰å“åº” DOM æ“ä½œè€Œè§¦å‘çš„ä»»åŠ¡ï¼Œä¾‹å¦‚å½“è¯¥å…ƒç´ æ’å…¥åˆ° document ä¸­æ—¶ã€‚</li>
</ul>
<p>ä»»åŠ¡æ˜¯ä¸€ä¸ªç»“æ„, å®ƒå…·æœ‰ï¼š</p>
<ul>
<li><p>steps
A series of steps specifying the work to be done by the task.</p>
</li>
<li><p>source
One of the task sources, used to group and serialize related tasks.</p>
</li>
<li><p>document
A Document associated with the task, or null for tasks that are not in a window event loop.</p>
</li>
<li><p>A script evaluation environment settings object set
A set of environment settings objects used for tracking script evaluation during the task.</p>
<p>æ¯ä¸ªä»»åŠ¡éƒ½æ¥è‡ªç‰¹å®šçš„ä»»åŠ¡æºã€‚æœ¬è´¨ä¸Šï¼Œåœ¨æ ‡å‡†ä¸­ä»»åŠ¡æºç”¨äºåˆ’åˆ†é€»è¾‘ä¸Šä¸åŒç±»å‹çš„ä»»åŠ¡ï¼Œç”¨æˆ·ä»£ç†ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—æ¥åˆå¹¶äº‹ä»¶å¾ªç¯ä¸­çš„ä»»åŠ¡æºã€‚</p>
</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<p>ä¸€ä¸ªç”¨æˆ·ä»£ç†å¯ä»¥æœ‰ä¸€ä¸ªé¼ æ ‡å’ŒæŒ‰é”®äº‹ä»¶çš„ä»»åŠ¡é˜Ÿåˆ—ï¼ˆç”¨æˆ·äº¤äº’ä»»åŠ¡æºä¸ä¹‹ç›¸å…³è”ï¼‰ï¼Œè€Œå¦ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—åˆ™ä¸æ‰€æœ‰å…¶ä»–ä»»åŠ¡æºç›¸å…³è”ã€‚ ç„¶åï¼Œä½¿ç”¨åœ¨äº‹ä»¶å¾ªç¯å¤„ç†æ¨¡å‹çš„åˆå§‹æ­¥éª¤ä¸­æˆäºˆçš„è‡ªç”±åº¦ï¼Œå®ƒå¯ä»¥åœ¨å››åˆ†ä¹‹ä¸‰çš„æ—¶é—´å†…è®©é”®ç›˜å’Œé¼ æ ‡äº‹ä»¶ä¼˜å…ˆäºå…¶ä»–ä»»åŠ¡ï¼Œä¿æŒç•Œé¢å“åº”ä½†ä¸ä¼šé¥¿æ­»å…¶ä»–ä»»åŠ¡é˜Ÿåˆ—ã€‚è¯·æ³¨æ„ï¼Œåœ¨æ­¤è®¾ç½®ä¸­ï¼Œå¤„ç†æ¨¡å‹ä»ç„¶å¼ºåˆ¶ç”¨æˆ·ä»£ç†æ°¸è¿œä¸ä¼šæ— åºåœ°å¤„ç†æ¥è‡ªä»»ä½•ä¸€ä¸ªä»»åŠ¡æºçš„äº‹ä»¶ã€‚</p>
<p>æ¯ä¸ªäº‹ä»¶å¾ªç¯éƒ½æœ‰ä¸€ä¸ªå½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªä»»åŠ¡æˆ– nullã€‚é»˜è®¤ä¸º nullã€‚
æ¯ä¸ªäº‹ä»¶å¾ªç¯éƒ½æœ‰ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡çš„é˜Ÿåˆ—ï¼Œåˆå§‹ä¸ºç©ºã€‚</p>
<h3 id="é€šç”¨ä»»åŠ¡æº">é€šç”¨ä»»åŠ¡æº</h3>
<ul>
<li><p>DOM æ“ä½œä»»åŠ¡æº
æ­¤ä»»åŠ¡æºç”¨äºå¯¹ DOM æ“ä½œåšå‡ºååº”çš„åŠŸèƒ½ï¼Œä¾‹å¦‚åœ¨å°†å…ƒç´ æ’å…¥æ–‡æ¡£æ—¶ä»¥éé˜»å¡æ–¹å¼å‘ç”Ÿçš„äº‹æƒ…ã€‚</p>
</li>
<li><p>ç”¨æˆ·äº¤äº’ä»»åŠ¡æº
æ­¤ä»»åŠ¡æºç”¨äºå“åº”ç”¨æˆ·äº¤äº’çš„åŠŸèƒ½ï¼Œä¾‹å¦‚é”®ç›˜æˆ–é¼ æ ‡è¾“å…¥ã€‚
ä¸ºå“åº”ç”¨æˆ·è¾“å…¥è€Œå‘é€çš„ <code>click</code> äº‹ä»¶ï¼ˆä¾‹å¦‚äº‹ä»¶ï¼‰å¿…é¡»ä½¿ç”¨ä¸ç”¨æˆ·äº¤äº’ä»»åŠ¡æºä¸€èµ·æ’é˜Ÿçš„ä»»åŠ¡æ¥è§¦å‘ã€‚[UI äº‹ä»¶]</p>
</li>
<li><p>ç½‘ç»œä»»åŠ¡æº
æ­¤ä»»åŠ¡æºç”¨äºå“åº”ç½‘ç»œæ´»åŠ¨è€Œè§¦å‘çš„åŠŸèƒ½ã€‚</p>
</li>
<li><p>å†å²éå†ä»»åŠ¡æº
æ­¤ä»»åŠ¡æºç”¨äºå¯¹è°ƒç”¨ <code>history.back()</code> å’Œç±»ä¼¼ API è¿›è¡Œæ’é˜Ÿã€‚</p>
</li>
</ul>
<h2 id="äº‹ä»¶å¾ªç¯çš„å¤„ç†æ¨¡å¼">äº‹ä»¶å¾ªç¯çš„å¤„ç†æ¨¡å¼</h2>
<p>æ ¹æ® whatwg å…³äºäº‹ä»¶å¾ªç¯æ ‡å‡†ä¸­ <a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model">Processing model</a>ï¼Œå½“ä¸€ä¸ªäº‹ä»¶å¾ªç¯å­˜åœ¨ï¼Œå®ƒå°±ä¼šä¸æ–­çš„æ‰§è¡Œä¸€ä¸‹æ­¥éª¤:</p>
<ul>
<li>è®©ä»»åŠ¡é˜Ÿåˆ—æˆä¸ºäº‹ä»¶å¾ªç¯çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œé€‰æ‹©çš„ä»»åŠ¡é˜Ÿåˆ—å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè‹¥æ²¡æœ‰è¿™æ ·çš„é˜Ÿåˆ—ï¼Œåˆ™ç›´æ¥è·³åˆ° Mircotasks æ­¥éª¤ã€‚</li>
<li>ä»ä»»åŠ¡é˜Ÿåˆ—é‡Œå–å‡ºç¬¬ä¸€ä¸ªå¯æ‰§è¡Œçš„ä»»åŠ¡</li>
<li>å°†è¯¥ä»»åŠ¡èµ‹ç»™äº‹ä»¶å¾ªç¯çš„ <code>currently running task</code></li>
<li>è®°å½•ä»»åŠ¡èµ·å§‹æ—¶é—´</li>
<li>æ‰§è¡Œä»»åŠ¡</li>
<li>äº‹ä»¶å¾ªç¯</li>
<li>å°†äº‹ä»¶å¾ªç¯çš„ <code>currently running task</code> é‡ç½®ä¸º null</li>
<li>Mircotasks: æ‰§è¡Œ <code>microtask checkpoint</code><ul>
<li>å¦‚æœ <code>microtask checkpoint</code> æ˜¯ true åˆ™è¿”å›</li>
<li>å°† <code>microtask checkpoint</code> è®¾ç½®ä¸º true</li>
<li>å½“å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºï¼š<ul>
<li>ä»å¾®ä»»åŠ¡é˜Ÿåˆ—å‡ºåˆ—ä¸€ä¸ªå¾®ä»»åŠ¡</li>
<li>æ‰§è¡Œè¯¥å¾®ä»»åŠ¡</li>
</ul>
</li>
<li>å°† <code>microtask checkpoint</code> è®¾ç½®ä¸º false</li>
</ul>
</li>
<li>å°† <code>hasARenderingOpportunity</code> ç½®ä¸º false</li>
<li>è®°å½•å½“å‰æ—¶é—´</li>
<li>report ä»»åŠ¡æ‰§è¡Œæ—¶é—´</li>
<li>æ›´æ–°æ¸²æŸ“ï¼šå¦‚æœè¿™ä¸ªäº‹ä»¶å¾ªç¯æ˜¯ <code>window event loop</code>ï¼š<ul>
<li>ä»¤ docs ä¸ºè¯¥äº‹ä»¶å¾ªç¯çš„æ‰€æœ‰ Document å¯¹è±¡</li>
<li>æ¸²æŸ“æœºä¼šï¼šä» docs ä¸­åˆ é™¤æµè§ˆä¸Šä¸‹æ–‡æ²¡æœ‰æ¸²æŸ“æœºä¼šçš„æ‰€æœ‰ Document å¯¹è±¡
å¦‚æœç”¨æˆ·ä»£ç†å½“å‰èƒ½å¤Ÿå‘ç”¨æˆ·å‘ˆç°æµè§ˆä¸Šä¸‹æ–‡çš„å†…å®¹ï¼Œæµè§ˆä¸Šä¸‹æ–‡å°±æœ‰æ¸²æŸ“æœºä¼šã€‚
æµè§ˆä¸Šä¸‹æ–‡å‘ˆç°æœºä¼šæ˜¯æ ¹æ®ç¡¬ä»¶çº¦æŸï¼ˆä¾‹å¦‚æ˜¾ç¤ºåˆ·æ–°ç‡ï¼‰å’Œå…¶ä»–å› ç´ ï¼ˆä¾‹å¦‚é¡µé¢æ€§èƒ½æˆ–æ–‡æ¡£çš„å¯è§æ€§çŠ¶æ€æ˜¯å¦ä¸º <code>visible</code>ï¼‰ç¡®å®šçš„ã€‚
æ¸²æŸ“æœºä¼šé€šå¸¸å®šæœŸå‘ç”Ÿã€‚
æ ‡å‡†ä¸å¼ºåˆ¶è¦æ±‚æŒ‰ä»»ä½•ç‰¹å®šæ¨¡å‹æ¥é€‰æ‹©æ¸²æŸ“æœºä¼šã€‚æ¯”å¦‚ï¼Œå¦‚æœæµè§ˆå™¨è¯•å›¾è¾¾åˆ° 60Hz åˆ·æ–°ç‡ï¼Œé‚£ä¹ˆæ¸²æŸ“æœºä¼šæœ€å¤šå¯è¾¾æ¯ç§’ 60 æ¬¡ï¼Œæ¯æ¬¡å¤§çº¦ 16.7msã€‚
å¦‚æœæµè§ˆå™¨å‘ç°æµè§ˆä¸Šä¸‹æ–‡æ— æ³•ç»´æŒæ­¤é€Ÿç‡ï¼Œåˆ™è¯¥æµè§ˆä¸Šä¸‹æ–‡å¯èƒ½ä¼šä¸‹é™åˆ°æ›´å¯æŒç»­çš„æ¯ç§’ 30 æ¬¡æ¸²æŸ“æœºä¼šï¼Œè€Œä¸æ˜¯å¶å°”ä¸¢å¸§ã€‚å¦‚æœæµè§ˆä¸Šä¸‹æ–‡ä¸å¯è§ï¼Œuser agent å¯èƒ½ä¼šå†³å®šå°†è¯¥é¡µé¢é™ä½åˆ°æ¯ç§’ 4 æ¬¡ç”šè‡³æ›´ä½çš„é¢‘ç‡ã€‚</li>
<li>å¦‚æœ docs ä¸ä¸ºç©ºï¼Œå°† <code>hasARenderingOpportunity</code> ä¸º trueã€‚</li>
<li>ä¸å¿…è¦çš„æ¸²æŸ“ï¼šæ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶çš„ Document å°†è¢«ä» docs ä¸­ç§»é™¤ï¼š<ul>
<li>user agent è®¤ä¸ºæ›´æ–° Document æµè§ˆä¸Šä¸‹æ–‡çš„æ¸²æŸ“ä¸ä¼šæœ‰æ˜æ˜¾çš„æ•ˆæœï¼Œå¹¶ä¸”</li>
<li>Document çš„ <code>map of animation frame callback</code> ä¸ºç©ºï¼ˆå¯ä»¥ç†è§£ä¸º <code>requestAnimationFrame callback</code> ä¸ºç©ºï¼‰ã€‚</li>
</ul>
</li>
<li>å¯¹äº docs å¯¹è±¡ä¸­çš„æ¯ä¸ªæ´»åŠ¨ document æ–‡æ¡£<ul>
<li><a href="https://html.spec.whatwg.org/multipage/interaction.html#flush-autofocus-candidates">åˆ·æ–° autofocus</a>ã€‚</li>
<li><a href="https://drafts.csswg.org/cssom-view/#run-the-resize-steps">æ‰§è¡Œ resize æ­¥éª¤</a>ã€‚</li>
<li><a href="https://drafts.csswg.org/cssom-view/#run-the-scroll-steps">æ‰§è¡Œ scroll æ­¥éª¤</a>ã€‚</li>
<li><a href="https://drafts.csswg.org/cssom-view/#evaluate-media-queries-and-report-changes">æ‰§è¡Œåª’ä½“æŸ¥è¯¢</a>ã€‚</li>
<li><a href="https://drafts.csswg.org/web-animations/#update-animations-and-send-events">æ›´æ–°åŠ¨ç”»å¹¶å‘é€äº‹ä»¶</a>ã€‚</li>
<li><a href="https://fullscreen.spec.whatwg.org/#run-the-fullscreen-steps">æ‰§è¡Œå…¨å±æ­¥éª¤</a>ã€‚</li>
<li>user agent æ£€æµ‹åˆ°ä¸ <code>CanvasRenderingContext2D</code> æˆ– <code>OffscreenCanvasRenderingContext2D</code> å…³è”çš„ context å·²ç»ä¸¢å¤±ï¼Œåˆ™æ‰§è¡Œ <code>context to lost</code> æ­¥éª¤ã€‚</li>
<li><a href="https://html.spec.whatwg.org/multipage/imagebitmap-and-animations.html#run-the-animation-frame-callbacks">æ‰§è¡Œ animationFrame å›è°ƒ</a>ï¼Œå³ requestAnimationFrame çš„å›è°ƒã€‚</li>
<li><a href="https://w3c.github.io/IntersectionObserver/#run-the-update-intersection-observations-steps">æ‰§è¡Œ intersection observations æ­¥éª¤</a>ï¼Œå³ <code>IntersectionObserver</code> å›è°ƒã€‚</li>
<li>è°ƒç”¨ <code>mark paint timeing</code> ç®—æ³•ã€‚</li>
<li>æ›´æ–° Document å¯¹åº”çš„å‘ˆç°æˆ–ç”¨æˆ·ç•Œé¢åŠå…¶æµè§ˆä¸Šä¸‹æ–‡ï¼Œä»¥åæ˜ å½“å‰çŠ¶æ€ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>å¦‚æœä»¥ä¸‹æ‰€æœ‰éƒ½ä¸ºçœŸ<ul>
<li>this is a window event loop</li>
<li>in this event loop&#39;s task queues, there is no task whose document is fully active</li>
<li>this event loop&#39;s microtask queue is empty</li>
<li>hasARenderingOpportunity is false
åˆ™ï¼š<ul>
<li>è®¡ç®— <code>computeDeadline</code></li>
<li>ä¸ºå¸¦ <code>computeDeadline</code> çš„ window æ‰§è¡Œ <a href="https://w3c.github.io/requestidlecallback/#start-an-idle-period-algorithm">start an idle period algorithm</a>ï¼ˆrequestIdleCallbackï¼‰</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="å¾®ä»»åŠ¡æ’é˜Ÿ">å¾®ä»»åŠ¡æ’é˜Ÿ</h2>
<p>æ ¹æ® <a href="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#microtask-queuing">whatwg æ ‡å‡† å¾®ä»»åŠ¡æ’é˜Ÿ</a>ï¼Œ<code>self.queueMicrotask(callback)</code> å¯ç”¨äºåœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸Šæ·»åŠ å¾®ä»»åŠ¡ã€‚è¿™å…è®¸ä»–ä»¬çš„ä»£ç åœ¨ä¸‹ä¸€æ¬¡ js æ‰§è¡Œä¸Šä¸‹æ–‡å †æ ˆä¸ºç©ºæ—¶è¿è¡Œã€‚ ä¸è¿‡ï¼Œè°ƒåº¦å¤§é‡å¾®ä»»åŠ¡å’Œè¿è¡Œå¤§é‡åŒæ­¥ä»£ç å…·æœ‰ç›¸åŒçš„æ€§èƒ½åŠ£åŠ¿ã€‚ä¸¤è€…éƒ½ä¼šé˜»æ­¢æµè§ˆå™¨æ¸²æŸ“ã€‚</p>
<p>åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œ<code>requestAnimationFrame()</code> æˆ–è€… <code>requestIdleCallback()</code> æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ç‰¹åˆ«æ˜¯ï¼Œå¦‚æœç›®æ ‡æ˜¯åœ¨ä¸‹ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸä¹‹å‰è¿è¡Œä»£ç ï¼Œå°±ç”¨ <code>requestAnimationFrame()</code>ã€‚</p>
<p><code>queueMicrotask()</code> æœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯æ˜¯åˆ›å»ºä¸€è‡´çš„æ’åºï¼Œå³ä½¿åœ¨ä¿¡æ¯åŒæ­¥å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œä¹Ÿä¸ä¼šå¼•å…¥è¿‡åº¦å»¶è¿Ÿã€‚</p>
<pre><code class="language-js">MyElement.prototype.loadData = function (url) {
  if (this._cache[url]) {
    queueMicrotask(() =&gt; {
      this._setData(this._cache[url])
      this.dispatchEvent(new Event(&#39;load&#39;))
    })
  } else {
    fetch(url)
      .then((res) =&gt; res.arrayBuffer())
      .then((data) =&gt; {
        this._cache[url] = data
        this._setData(data)
        this.dispatchEvent(new Event(&#39;load&#39;))
      })
  }
}
</code></pre>
<p>è¿™æ ·èƒ½ä¿è¯æœ‰æ—  cache è¿è¡Œé¡ºåºéƒ½ä¸€è‡´ã€‚</p>
<p>å¦ä¸€ä¸ªä½¿ç”¨åœºæ™¯æ˜¯å®ç°ä¸åè°ƒçš„â€œæ‰¹å¤„ç†â€ï¼Œæ¯”å¦‚è¯´ï¼Œä½ æƒ³å°½å¯èƒ½å¿«åœ°å°†æ•°æ®å‘é€å‡ºå»ï¼Œä½†åˆä¸æƒ³å‘å‡ºå¤šä¸ªç½‘ç»œè¯·æ±‚ï¼Œè¿™æ—¶å°±å¯ä»¥ç”¨ <code>queueMicrotask</code>ï¼š</p>
<pre><code class="language-js">const queuedToSend = []

function sendData(data) {
  queuedToSend.push(data)

  if (queuedToSend.length === 1) {
    queueMicrotask(() =&gt; {
      const stringToSend = JSON.stringify(queuedToSend)
      queuedToSend.length = 0

      fetch(&#39;/endpoint&#39;, stringToSend)
    })
  }
}
</code></pre>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æµè§ˆå™¨ä¸­çš„äº‹ä»¶å¾ªç¯ä¸»è¦ç”± Taskã€Microtask å’Œ Render ä¸‰ä¸ªè¿‡ç¨‹ç»„æˆï¼Œæ¯ä¸€è½®äº‹ä»¶å¾ªç¯éƒ½ä¼šæ£€æŸ¥ä¸¤ä¸ªä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æœ‰è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç­‰ js ä¸Šä¸‹æ–‡æ‰§è¡Œæ ˆæ¸…ç©ºåï¼Œå…ˆæ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œæ‰€æœ‰çš„ä»»åŠ¡ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦éœ€è¦æ¸²æŸ“ï¼Œå¦‚æœä¸éœ€è¦æ¸²æŸ“ç»§ç»­ä¸‹ä¸€è½®å¾ªç¯ã€‚æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸æ˜¯æ¯ä¸€è½®äº‹ä»¶å¾ªç¯éƒ½ä¼šæ¸²æŸ“ï¼Œå¦‚æœæƒ³åœ¨æ¯æ¬¡äº‹ä»¶å¾ªç¯ä¸­æˆ–å¾®ä»»åŠ¡ä¹‹åæ‰§è¡Œä¸€æ¬¡ç»˜åˆ¶ï¼Œå¯ä»¥é€šè¿‡ <code>requestAnimationFrame</code> é‡æ–°æ¸²æŸ“ã€‚</p>
</section></article></div><aside class="panel"><ul class="panel-list panel-list--gray"><li><input type="radio" id="font-classic" value="heti--classic" name="font" checked=""/><label for="font-classic">ä¼ ç»Ÿ</label></li><li><input type="radio" id="font-sans" value="heti--sans" name="font"/><label for="font-sans">é»‘ä½“</label></li><li><input type="radio" id="font-serif" value="heti--serif" name="font"/><label for="font-serif">å®‹ä½“</label></li></ul><ul class="panel-list panel-list--gray panel-list--icon"><li><input type="radio" value="auto" name="darkmode" id="darkmode-auto"/><label for="darkmode-auto">ğŸŒ—</label></li><li><input type="radio" value="light" name="darkmode" id="darkmode-light"/><label for="darkmode-light">ğŸŒ</label></li><li><input type="radio" value="dark" name="darkmode" id="darkmode-dark" checked=""/><label for="darkmode-dark">ğŸŒ™</label></li></ul></aside></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"Event Loop","date":"2022-01-09 21:39:00","excerpt":"React çš„æ¶æ„ä»¥åŠ render å’Œ commit é˜¶æ®µ"},"slug":"Event-Loop","content":"\n## å®šä¹‰\n\nwhatwg çš„æ ‡å‡†é‡Œé¢è®²äº†ï¼Œä¸ºäº†åè°ƒäº‹ä»¶ã€ç”¨æˆ·äº¤äº’ã€è„šæœ¬ã€æ¸²æŸ“ã€ç½‘ç»œç­‰ï¼Œç”¨æˆ·ä»£ç†å¿…é¡»ä½¿ç”¨äº‹ä»¶å¾ªç¯ã€‚æ¯ä¸ªä»£ç†éƒ½æœ‰ä¸€ä¸ªå…³è”çš„äº‹ä»¶å¾ªç¯ï¼Œè¿™æ˜¯è¯¥ä»£ç†ç‹¬æœ‰çš„ã€‚\n\n\u003e The event loop of a similar-origin window agent is known as a window event loop. The event loop of a dedicated worker agent, shared worker agent, or service worker agent is known as a worker event loop. And the event loop of a worklet agent is known as a worklet event loop.\n\nä¸€ä¸ªäº‹ä»¶å¾ªç¯æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª task queuesã€‚ä¸€ä¸ª task queue æ˜¯ä¸€ä¸ª tasks setã€‚\n\n\u003e Task queues are sets, not queues, because step one of the event loop processing model grabs the first runnable task from the chosen queue, instead of dequeuing the first task.The microtask queue is not a task queue.\n\n## ä»»åŠ¡\n\nä»»åŠ¡å°è£…äº†å¦‚ä¸‹çš„ç®—æ³•ï¼š\n\n- Event: æ´¾å‘ä¸€ä¸ªäº‹ä»¶ç»™ç‰¹å®šçš„ target ç»å¸¸æ˜¯ç”±ä¸“é—¨çš„ä»»åŠ¡å»å®Œæˆçš„ã€‚\n- Parsingï¼š HTML è§£æé€šå¸¸æ˜¯ä¸€ä¸ªä»»åŠ¡ã€‚\n- Callbacksï¼šè°ƒç”¨ä¸€ä¸ªå›è°ƒç»å¸¸æ˜¯ç”±ä¸€ä¸ªä¸“é—¨çš„ä»»åŠ¡å®Œæˆã€‚\n- Using a resource\n- Reacting to DOM manipulation: ä¸€äº›å…ƒç´ å…·æœ‰å“åº” DOM æ“ä½œè€Œè§¦å‘çš„ä»»åŠ¡ï¼Œä¾‹å¦‚å½“è¯¥å…ƒç´ æ’å…¥åˆ° document ä¸­æ—¶ã€‚\n\nä»»åŠ¡æ˜¯ä¸€ä¸ªç»“æ„, å®ƒå…·æœ‰ï¼š\n\n- steps\n  A series of steps specifying the work to be done by the task.\n- source\n  One of the task sources, used to group and serialize related tasks.\n- document\n  A Document associated with the task, or null for tasks that are not in a window event loop.\n- A script evaluation environment settings object set\n  A set of environment settings objects used for tracking script evaluation during the task.\n\n  æ¯ä¸ªä»»åŠ¡éƒ½æ¥è‡ªç‰¹å®šçš„ä»»åŠ¡æºã€‚æœ¬è´¨ä¸Šï¼Œåœ¨æ ‡å‡†ä¸­ä»»åŠ¡æºç”¨äºåˆ’åˆ†é€»è¾‘ä¸Šä¸åŒç±»å‹çš„ä»»åŠ¡ï¼Œç”¨æˆ·ä»£ç†ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—æ¥åˆå¹¶äº‹ä»¶å¾ªç¯ä¸­çš„ä»»åŠ¡æºã€‚\n\nä¾‹å­ï¼š\n\nä¸€ä¸ªç”¨æˆ·ä»£ç†å¯ä»¥æœ‰ä¸€ä¸ªé¼ æ ‡å’ŒæŒ‰é”®äº‹ä»¶çš„ä»»åŠ¡é˜Ÿåˆ—ï¼ˆç”¨æˆ·äº¤äº’ä»»åŠ¡æºä¸ä¹‹ç›¸å…³è”ï¼‰ï¼Œè€Œå¦ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—åˆ™ä¸æ‰€æœ‰å…¶ä»–ä»»åŠ¡æºç›¸å…³è”ã€‚ ç„¶åï¼Œä½¿ç”¨åœ¨äº‹ä»¶å¾ªç¯å¤„ç†æ¨¡å‹çš„åˆå§‹æ­¥éª¤ä¸­æˆäºˆçš„è‡ªç”±åº¦ï¼Œå®ƒå¯ä»¥åœ¨å››åˆ†ä¹‹ä¸‰çš„æ—¶é—´å†…è®©é”®ç›˜å’Œé¼ æ ‡äº‹ä»¶ä¼˜å…ˆäºå…¶ä»–ä»»åŠ¡ï¼Œä¿æŒç•Œé¢å“åº”ä½†ä¸ä¼šé¥¿æ­»å…¶ä»–ä»»åŠ¡é˜Ÿåˆ—ã€‚è¯·æ³¨æ„ï¼Œåœ¨æ­¤è®¾ç½®ä¸­ï¼Œå¤„ç†æ¨¡å‹ä»ç„¶å¼ºåˆ¶ç”¨æˆ·ä»£ç†æ°¸è¿œä¸ä¼šæ— åºåœ°å¤„ç†æ¥è‡ªä»»ä½•ä¸€ä¸ªä»»åŠ¡æºçš„äº‹ä»¶ã€‚\n\næ¯ä¸ªäº‹ä»¶å¾ªç¯éƒ½æœ‰ä¸€ä¸ªå½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªä»»åŠ¡æˆ– nullã€‚é»˜è®¤ä¸º nullã€‚\næ¯ä¸ªäº‹ä»¶å¾ªç¯éƒ½æœ‰ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡çš„é˜Ÿåˆ—ï¼Œåˆå§‹ä¸ºç©ºã€‚\n\n### é€šç”¨ä»»åŠ¡æº\n\n- DOM æ“ä½œä»»åŠ¡æº\n  æ­¤ä»»åŠ¡æºç”¨äºå¯¹ DOM æ“ä½œåšå‡ºååº”çš„åŠŸèƒ½ï¼Œä¾‹å¦‚åœ¨å°†å…ƒç´ æ’å…¥æ–‡æ¡£æ—¶ä»¥éé˜»å¡æ–¹å¼å‘ç”Ÿçš„äº‹æƒ…ã€‚\n\n- ç”¨æˆ·äº¤äº’ä»»åŠ¡æº\n  æ­¤ä»»åŠ¡æºç”¨äºå“åº”ç”¨æˆ·äº¤äº’çš„åŠŸèƒ½ï¼Œä¾‹å¦‚é”®ç›˜æˆ–é¼ æ ‡è¾“å…¥ã€‚\n  ä¸ºå“åº”ç”¨æˆ·è¾“å…¥è€Œå‘é€çš„ `click` äº‹ä»¶ï¼ˆä¾‹å¦‚äº‹ä»¶ï¼‰å¿…é¡»ä½¿ç”¨ä¸ç”¨æˆ·äº¤äº’ä»»åŠ¡æºä¸€èµ·æ’é˜Ÿçš„ä»»åŠ¡æ¥è§¦å‘ã€‚[UI äº‹ä»¶]\n\n- ç½‘ç»œä»»åŠ¡æº\n  æ­¤ä»»åŠ¡æºç”¨äºå“åº”ç½‘ç»œæ´»åŠ¨è€Œè§¦å‘çš„åŠŸèƒ½ã€‚\n\n- å†å²éå†ä»»åŠ¡æº\n  æ­¤ä»»åŠ¡æºç”¨äºå¯¹è°ƒç”¨ `history.back()` å’Œç±»ä¼¼ API è¿›è¡Œæ’é˜Ÿã€‚\n\n## äº‹ä»¶å¾ªç¯çš„å¤„ç†æ¨¡å¼\n\næ ¹æ® whatwg å…³äºäº‹ä»¶å¾ªç¯æ ‡å‡†ä¸­ [Processing model](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model)ï¼Œå½“ä¸€ä¸ªäº‹ä»¶å¾ªç¯å­˜åœ¨ï¼Œå®ƒå°±ä¼šä¸æ–­çš„æ‰§è¡Œä¸€ä¸‹æ­¥éª¤:\n\n- è®©ä»»åŠ¡é˜Ÿåˆ—æˆä¸ºäº‹ä»¶å¾ªç¯çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œé€‰æ‹©çš„ä»»åŠ¡é˜Ÿåˆ—å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè‹¥æ²¡æœ‰è¿™æ ·çš„é˜Ÿåˆ—ï¼Œåˆ™ç›´æ¥è·³åˆ° Mircotasks æ­¥éª¤ã€‚\n- ä»ä»»åŠ¡é˜Ÿåˆ—é‡Œå–å‡ºç¬¬ä¸€ä¸ªå¯æ‰§è¡Œçš„ä»»åŠ¡\n- å°†è¯¥ä»»åŠ¡èµ‹ç»™äº‹ä»¶å¾ªç¯çš„ `currently running task`\n- è®°å½•ä»»åŠ¡èµ·å§‹æ—¶é—´\n- æ‰§è¡Œä»»åŠ¡\n- äº‹ä»¶å¾ªç¯\n- å°†äº‹ä»¶å¾ªç¯çš„ `currently running task` é‡ç½®ä¸º null\n- Mircotasks: æ‰§è¡Œ `microtask checkpoint`\n  - å¦‚æœ `microtask checkpoint` æ˜¯ true åˆ™è¿”å›\n  - å°† `microtask checkpoint` è®¾ç½®ä¸º true\n  - å½“å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºï¼š\n    - ä»å¾®ä»»åŠ¡é˜Ÿåˆ—å‡ºåˆ—ä¸€ä¸ªå¾®ä»»åŠ¡\n    - æ‰§è¡Œè¯¥å¾®ä»»åŠ¡\n  - å°† `microtask checkpoint` è®¾ç½®ä¸º false\n- å°† `hasARenderingOpportunity` ç½®ä¸º false\n- è®°å½•å½“å‰æ—¶é—´\n- report ä»»åŠ¡æ‰§è¡Œæ—¶é—´\n- æ›´æ–°æ¸²æŸ“ï¼šå¦‚æœè¿™ä¸ªäº‹ä»¶å¾ªç¯æ˜¯ `window event loop`ï¼š\n  - ä»¤ docs ä¸ºè¯¥äº‹ä»¶å¾ªç¯çš„æ‰€æœ‰ Document å¯¹è±¡\n  - æ¸²æŸ“æœºä¼šï¼šä» docs ä¸­åˆ é™¤æµè§ˆä¸Šä¸‹æ–‡æ²¡æœ‰æ¸²æŸ“æœºä¼šçš„æ‰€æœ‰ Document å¯¹è±¡\n    å¦‚æœç”¨æˆ·ä»£ç†å½“å‰èƒ½å¤Ÿå‘ç”¨æˆ·å‘ˆç°æµè§ˆä¸Šä¸‹æ–‡çš„å†…å®¹ï¼Œæµè§ˆä¸Šä¸‹æ–‡å°±æœ‰æ¸²æŸ“æœºä¼šã€‚\n    æµè§ˆä¸Šä¸‹æ–‡å‘ˆç°æœºä¼šæ˜¯æ ¹æ®ç¡¬ä»¶çº¦æŸï¼ˆä¾‹å¦‚æ˜¾ç¤ºåˆ·æ–°ç‡ï¼‰å’Œå…¶ä»–å› ç´ ï¼ˆä¾‹å¦‚é¡µé¢æ€§èƒ½æˆ–æ–‡æ¡£çš„å¯è§æ€§çŠ¶æ€æ˜¯å¦ä¸º `visible`ï¼‰ç¡®å®šçš„ã€‚\n    æ¸²æŸ“æœºä¼šé€šå¸¸å®šæœŸå‘ç”Ÿã€‚\n    æ ‡å‡†ä¸å¼ºåˆ¶è¦æ±‚æŒ‰ä»»ä½•ç‰¹å®šæ¨¡å‹æ¥é€‰æ‹©æ¸²æŸ“æœºä¼šã€‚æ¯”å¦‚ï¼Œå¦‚æœæµè§ˆå™¨è¯•å›¾è¾¾åˆ° 60Hz åˆ·æ–°ç‡ï¼Œé‚£ä¹ˆæ¸²æŸ“æœºä¼šæœ€å¤šå¯è¾¾æ¯ç§’ 60 æ¬¡ï¼Œæ¯æ¬¡å¤§çº¦ 16.7msã€‚\n    å¦‚æœæµè§ˆå™¨å‘ç°æµè§ˆä¸Šä¸‹æ–‡æ— æ³•ç»´æŒæ­¤é€Ÿç‡ï¼Œåˆ™è¯¥æµè§ˆä¸Šä¸‹æ–‡å¯èƒ½ä¼šä¸‹é™åˆ°æ›´å¯æŒç»­çš„æ¯ç§’ 30 æ¬¡æ¸²æŸ“æœºä¼šï¼Œè€Œä¸æ˜¯å¶å°”ä¸¢å¸§ã€‚å¦‚æœæµè§ˆä¸Šä¸‹æ–‡ä¸å¯è§ï¼Œuser agent å¯èƒ½ä¼šå†³å®šå°†è¯¥é¡µé¢é™ä½åˆ°æ¯ç§’ 4 æ¬¡ç”šè‡³æ›´ä½çš„é¢‘ç‡ã€‚\n  - å¦‚æœ docs ä¸ä¸ºç©ºï¼Œå°† `hasARenderingOpportunity` ä¸º trueã€‚\n  - ä¸å¿…è¦çš„æ¸²æŸ“ï¼šæ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶çš„ Document å°†è¢«ä» docs ä¸­ç§»é™¤ï¼š\n    - user agent è®¤ä¸ºæ›´æ–° Document æµè§ˆä¸Šä¸‹æ–‡çš„æ¸²æŸ“ä¸ä¼šæœ‰æ˜æ˜¾çš„æ•ˆæœï¼Œå¹¶ä¸”\n    - Document çš„ `map of animation frame callback` ä¸ºç©ºï¼ˆå¯ä»¥ç†è§£ä¸º `requestAnimationFrame callback` ä¸ºç©ºï¼‰ã€‚\n  - å¯¹äº docs å¯¹è±¡ä¸­çš„æ¯ä¸ªæ´»åŠ¨ document æ–‡æ¡£\n    - [åˆ·æ–° autofocus](https://html.spec.whatwg.org/multipage/interaction.html#flush-autofocus-candidates)ã€‚\n    - [æ‰§è¡Œ resize æ­¥éª¤](https://drafts.csswg.org/cssom-view/#run-the-resize-steps)ã€‚\n    - [æ‰§è¡Œ scroll æ­¥éª¤](https://drafts.csswg.org/cssom-view/#run-the-scroll-steps)ã€‚\n    - [æ‰§è¡Œåª’ä½“æŸ¥è¯¢](https://drafts.csswg.org/cssom-view/#evaluate-media-queries-and-report-changes)ã€‚\n    - [æ›´æ–°åŠ¨ç”»å¹¶å‘é€äº‹ä»¶](https://drafts.csswg.org/web-animations/#update-animations-and-send-events)ã€‚\n    - [æ‰§è¡Œå…¨å±æ­¥éª¤](https://fullscreen.spec.whatwg.org/#run-the-fullscreen-steps)ã€‚\n    - user agent æ£€æµ‹åˆ°ä¸ `CanvasRenderingContext2D` æˆ– `OffscreenCanvasRenderingContext2D` å…³è”çš„ context å·²ç»ä¸¢å¤±ï¼Œåˆ™æ‰§è¡Œ `context to lost` æ­¥éª¤ã€‚\n    - [æ‰§è¡Œ animationFrame å›è°ƒ](https://html.spec.whatwg.org/multipage/imagebitmap-and-animations.html#run-the-animation-frame-callbacks)ï¼Œå³ requestAnimationFrame çš„å›è°ƒã€‚\n    - [æ‰§è¡Œ intersection observations æ­¥éª¤](https://w3c.github.io/IntersectionObserver/#run-the-update-intersection-observations-steps)ï¼Œå³ `IntersectionObserver` å›è°ƒã€‚\n    - è°ƒç”¨ `mark paint timeing` ç®—æ³•ã€‚\n    - æ›´æ–° Document å¯¹åº”çš„å‘ˆç°æˆ–ç”¨æˆ·ç•Œé¢åŠå…¶æµè§ˆä¸Šä¸‹æ–‡ï¼Œä»¥åæ˜ å½“å‰çŠ¶æ€ã€‚\n- å¦‚æœä»¥ä¸‹æ‰€æœ‰éƒ½ä¸ºçœŸ\n  - this is a window event loop\n  - in this event loop's task queues, there is no task whose document is fully active\n  - this event loop's microtask queue is empty\n  - hasARenderingOpportunity is false\n    åˆ™ï¼š\n    - è®¡ç®— `computeDeadline`\n    - ä¸ºå¸¦ `computeDeadline` çš„ window æ‰§è¡Œ [start an idle period algorithm](https://w3c.github.io/requestidlecallback/#start-an-idle-period-algorithm)ï¼ˆrequestIdleCallbackï¼‰\n\n## å¾®ä»»åŠ¡æ’é˜Ÿ\n\næ ¹æ® [whatwg æ ‡å‡† å¾®ä»»åŠ¡æ’é˜Ÿ](https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#microtask-queuing)ï¼Œ`self.queueMicrotask(callback)` å¯ç”¨äºåœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸Šæ·»åŠ å¾®ä»»åŠ¡ã€‚è¿™å…è®¸ä»–ä»¬çš„ä»£ç åœ¨ä¸‹ä¸€æ¬¡ js æ‰§è¡Œä¸Šä¸‹æ–‡å †æ ˆä¸ºç©ºæ—¶è¿è¡Œã€‚ ä¸è¿‡ï¼Œè°ƒåº¦å¤§é‡å¾®ä»»åŠ¡å’Œè¿è¡Œå¤§é‡åŒæ­¥ä»£ç å…·æœ‰ç›¸åŒçš„æ€§èƒ½åŠ£åŠ¿ã€‚ä¸¤è€…éƒ½ä¼šé˜»æ­¢æµè§ˆå™¨æ¸²æŸ“ã€‚\n\nåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œ`requestAnimationFrame()` æˆ–è€… `requestIdleCallback()` æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ç‰¹åˆ«æ˜¯ï¼Œå¦‚æœç›®æ ‡æ˜¯åœ¨ä¸‹ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸä¹‹å‰è¿è¡Œä»£ç ï¼Œå°±ç”¨ `requestAnimationFrame()`ã€‚\n\n`queueMicrotask()` æœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯æ˜¯åˆ›å»ºä¸€è‡´çš„æ’åºï¼Œå³ä½¿åœ¨ä¿¡æ¯åŒæ­¥å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œä¹Ÿä¸ä¼šå¼•å…¥è¿‡åº¦å»¶è¿Ÿã€‚\n\n```js\nMyElement.prototype.loadData = function (url) {\n  if (this._cache[url]) {\n    queueMicrotask(() =\u003e {\n      this._setData(this._cache[url])\n      this.dispatchEvent(new Event('load'))\n    })\n  } else {\n    fetch(url)\n      .then((res) =\u003e res.arrayBuffer())\n      .then((data) =\u003e {\n        this._cache[url] = data\n        this._setData(data)\n        this.dispatchEvent(new Event('load'))\n      })\n  }\n}\n```\n\nè¿™æ ·èƒ½ä¿è¯æœ‰æ—  cache è¿è¡Œé¡ºåºéƒ½ä¸€è‡´ã€‚\n\nå¦ä¸€ä¸ªä½¿ç”¨åœºæ™¯æ˜¯å®ç°ä¸åè°ƒçš„â€œæ‰¹å¤„ç†â€ï¼Œæ¯”å¦‚è¯´ï¼Œä½ æƒ³å°½å¯èƒ½å¿«åœ°å°†æ•°æ®å‘é€å‡ºå»ï¼Œä½†åˆä¸æƒ³å‘å‡ºå¤šä¸ªç½‘ç»œè¯·æ±‚ï¼Œè¿™æ—¶å°±å¯ä»¥ç”¨ `queueMicrotask`ï¼š\n\n```js\nconst queuedToSend = []\n\nfunction sendData(data) {\n  queuedToSend.push(data)\n\n  if (queuedToSend.length === 1) {\n    queueMicrotask(() =\u003e {\n      const stringToSend = JSON.stringify(queuedToSend)\n      queuedToSend.length = 0\n\n      fetch('/endpoint', stringToSend)\n    })\n  }\n}\n```\n\n## æ€»ç»“\n\næµè§ˆå™¨ä¸­çš„äº‹ä»¶å¾ªç¯ä¸»è¦ç”± Taskã€Microtask å’Œ Render ä¸‰ä¸ªè¿‡ç¨‹ç»„æˆï¼Œæ¯ä¸€è½®äº‹ä»¶å¾ªç¯éƒ½ä¼šæ£€æŸ¥ä¸¤ä¸ªä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æœ‰è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç­‰ js ä¸Šä¸‹æ–‡æ‰§è¡Œæ ˆæ¸…ç©ºåï¼Œå…ˆæ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œæ‰€æœ‰çš„ä»»åŠ¡ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦éœ€è¦æ¸²æŸ“ï¼Œå¦‚æœä¸éœ€è¦æ¸²æŸ“ç»§ç»­ä¸‹ä¸€è½®å¾ªç¯ã€‚æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸æ˜¯æ¯ä¸€è½®äº‹ä»¶å¾ªç¯éƒ½ä¼šæ¸²æŸ“ï¼Œå¦‚æœæƒ³åœ¨æ¯æ¬¡äº‹ä»¶å¾ªç¯ä¸­æˆ–å¾®ä»»åŠ¡ä¹‹åæ‰§è¡Œä¸€æ¬¡ç»˜åˆ¶ï¼Œå¯ä»¥é€šè¿‡ `requestAnimationFrame` é‡æ–°æ¸²æŸ“ã€‚\n"},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"Event-Loop"},"buildId":"axI5iBLAatQt5APucXB_j","assetPrefix":"/next-blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>